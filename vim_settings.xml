<application>
  <component name="VimSettings">
    <state version="4" enabled="true" />
    <globalmarks />
    <filemarks>
      <file name="$USER_HOME$/data/code/react-auth/src/utils/http.js" timestamp="1561364999316">
        <mark key="[" line="105" column="36" />
      </file>
      <file name="$USER_HOME$/data/code/flowengine/flowable-engine/flowable/src/test/java/com/yunzainfo/cloud/flowable/test/ServiceTest.java" timestamp="1561372103910">
        <mark key="[" line="72" column="5" />
      </file>
      <file name="$USER_HOME$/data/code/react-auth/src/services/system/process.js" timestamp="1561430811365">
        <mark key="[" line="26" column="49" />
      </file>
      <file name="$USER_HOME$/data/code/react-auth/src/pages/Flow/FlowSetting.js" timestamp="1561604893015">
        <mark key="'" line="528" column="80" />
        <mark key="[" line="331" column="24" />
        <mark key="]" line="331" column="24" />
        <mark key="." line="331" column="24" />
        <mark key="^" line="317" column="11" />
      </file>
      <file name="$MAVEN_REPOSITORY$/org/springframework/spring-context/5.0.7.RELEASE/spring-context-5.0.7.RELEASE-sources.jar!/org/springframework/cache/interceptor/CacheAspectSupport.java" timestamp="1561540334240" />
      <file name="$USER_HOME$/data/code/react-auth/src/services/system/dept.js" timestamp="1561600113915" />
      <file name="$MAVEN_REPOSITORY$/org/flowable/flowable-spring-boot-autoconfigure/6.4.1/flowable-spring-boot-autoconfigure-6.4.1.jar!/org/flowable/spring/boot/dmn/FlowableDmnProperties.class" timestamp="1561543102132" />
      <file name="$USER_HOME$/data/code/flowengine/flowable-engine/flowable/src/main/resources/application-local.yml" timestamp="1561545642629">
        <mark key="[" line="2" column="1" />
        <mark key="]" line="3" column="0" />
        <mark key="." line="3" column="0" />
      </file>
      <file name="$USER_HOME$/data/code/flowengine/flowable-engine/flowable/src/main/java/com/yunzainfo/cloud/flowable/service/impl/ProcessServiceImpl.java" timestamp="1561519391184">
        <mark key="[" line="172" column="17" />
        <mark key="]" line="172" column="3" />
        <mark key="." line="172" column="17" />
      </file>
      <file name="$USER_HOME$/data/code/flowengine/flowable-engine/flowable/src/main/resources/application-local.properties" timestamp="1561543525115">
        <mark key="[" line="36" column="0" />
      </file>
      <file name="$USER_HOME$/data/code/react-auth/src/pages/Sys/UserInfo.js" timestamp="1561600289104" />
      <file name="$MAVEN_REPOSITORY$/org/flowable/flowable-spring-boot-autoconfigure/6.4.1/flowable-spring-boot-autoconfigure-6.4.1.jar!/org/flowable/spring/boot/FlowableProperties.class" timestamp="1561544149523" />
      <file name="$USER_HOME$/data/code/react-auth/src/models/design.js" timestamp="1561600597864">
        <mark key="[" line="135" column="23" />
        <mark key="]" line="135" column="23" />
        <mark key="." line="135" column="23" />
        <mark key="^" line="86" column="7" />
      </file>
      <file name="$USER_HOME$/data/code/react-auth/src/pages/FormBuilder/Editor/BasicEditor.jsx" timestamp="1561513864062" />
      <file name="$USER_HOME$/data/code/react-auth/src/pages/Flow/FormPermissions.js" timestamp="1561515107153">
        <mark key="[" line="74" column="57" />
        <mark key="]" line="74" column="57" />
        <mark key="." line="74" column="57" />
        <mark key="^" line="78" column="9" />
      </file>
      <file name="$USER_HOME$/data/code/react-auth/src/components/NoticeIcon/NoticeList.js" timestamp="1561538791404" />
      <file name="$USER_HOME$/data/code/react-auth/src/pages/Flow/FlowDesign.js" timestamp="1561532202838">
        <mark key="[" line="399" column="48" />
        <mark key="]" line="399" column="48" />
        <mark key="." line="399" column="48" />
        <mark key="^" line="373" column="2" />
      </file>
      <file name="$USER_HOME$/data/code/flowengine/flowable-engine/flowable/src/test/java/com/yunzainfo/cloud/flowable/test/ShareniuMuliInstanceJump.java" timestamp="1561348236721">
        <mark key="[" line="67" column="80" />
      </file>
      <file name="$MAVEN_REPOSITORY$/org/springframework/spring-context/5.0.7.RELEASE/spring-context-5.0.7.RELEASE-sources.jar!/org/springframework/cache/annotation/Cacheable.java" timestamp="1561540093906" />
      <file name="$USER_HOME$/data/code/react-auth/src/services/system/role.js" timestamp="1561531933129" />
      <file name="$USER_HOME$/data/code/newdemo/jpa/jpa-core/src/test/java/StudentTest.java" timestamp="1561367916549">
        <mark key="[" line="24" column="35" />
      </file>
      <file name="$USER_HOME$/data/code/react-auth/src/pages/Flow/UsersSelect.js" timestamp="1561604040274">
        <mark key="[" line="85" column="7" />
        <mark key="]" line="85" column="7" />
        <mark key="." line="85" column="7" />
        <mark key="^" line="17" column="0" />
      </file>
      <file name="$USER_HOME$/data/code/react-auth/src/pages/Flow/FlowDesign.less" timestamp="1561369855855">
        <mark key="[" line="6" column="24" />
      </file>
      <file name="$USER_HOME$/data/code/cloud/auth-center/src/main/java/com/yunzainfo/cloud/auth/service/impl/BaseMenuServiceImpl.java" timestamp="1561540209878">
        <mark key="[" line="107" column="8" />
        <mark key="]" line="107" column="8" />
        <mark key="." line="107" column="8" />
      </file>
      <file name="$MAVEN_REPOSITORY$/org/flowable/flowable-spring-boot-autoconfigure/6.4.1/flowable-spring-boot-autoconfigure-6.4.1.jar!/org/flowable/spring/boot/AbstractEngineAutoConfiguration.class" timestamp="1561544556909" />
      <file name="$USER_HOME$/data/code/cloud/file-center/file-core/src/main/resources/application-local.yml" timestamp="1561543567952">
        <mark key="[" line="56" column="93" />
      </file>
      <file name="$USER_HOME$/data/code/flowengine/flowable-engine/flowable/src/main/java/com/yunzainfo/cloud/flowable/config/ProcessEngineConfig.java" timestamp="1561543394868">
        <mark key="[" line="81" column="64" />
      </file>
    </filemarks>
    <jumps>
      <jump line="46" column="42" filename="$USER_HOME$/data/code/react-auth/src/models/user.js" />
      <jump line="52" column="17" filename="$USER_HOME$/data/code/react-auth/src/components/ServiceMenu/index.js" />
      <jump line="408" column="6" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="110" column="14" filename="$USER_HOME$/data/code/cloud/auth-center/src/main/java/com/yunzainfo/cloud/auth/web/BaseRoleController.java" />
      <jump line="43" column="19" filename="$USER_HOME$/data/code/react-auth/src/models/role.js" />
      <jump line="44" column="4" filename="$USER_HOME$/data/code/react-auth/src/models/role.js" />
      <jump line="46" column="13" filename="$USER_HOME$/data/code/react-auth/src/models/role.js" />
      <jump line="20" column="12" filename="$USER_HOME$/data/code/react-auth/src/models/role.js" />
      <jump line="371" column="20" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="384" column="16" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="436" column="27" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="387" column="20" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="548" column="2" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="536" column="14" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="22" column="1" filename="$USER_HOME$/data/code/react-auth/src/components/SiderMenu/BaseMenu.js" />
      <jump line="93" column="103" filename="$USER_HOME$/webapps/convert/src/main/java/com/yunzai/convert/web/ConvertController.java" />
      <jump line="29" column="12" filename="$USER_HOME$/webapps/convert/src/main/java/com/yunzai/convert/web/Up.java" />
      <jump line="117" column="27" filename="$USER_HOME$/data/code/plugins-notice/notice-web/src/main/webapp/resources/js/forworkflow/notice/NoticeFormWin.js" />
      <jump line="158" column="29" filename="$USER_HOME$/data/code/online-classroom/online-classroom-core/src/main/java/com/yunzainfo/oa/onlineclassroom/service/impl/HomeworkTeaServiceImpl.java" />
      <jump line="185" column="58" filename="$USER_HOME$/data/code/online-classroom/online-classroom-core/src/test/java/com/yunzai/test/AttTest.java" />
      <jump line="215" column="17" filename="$USER_HOME$/data/code/online-classroom/online-classroom-core/src/test/java/com/yunzai/test/AttTest.java" />
      <jump line="5" column="45" filename="$USER_HOME$/webapps/plugins-resource/resourcec-impl/src/main/resources/sqlMap/oracle/CourseTrainingMapper.xml" />
      <jump line="11" column="65" filename="$USER_HOME$/webapps/plugins-resource/resourcec-impl/src/main/resources/sqlMap/oracle/MajorTeacherMapper.xml" />
      <jump line="802" column="76" filename="$USER_HOME$/data/code/online-classroom/online-classroom-core/src/main/java/com/yunzainfo/oa/onlineclassroom/service/impl/BaseScheduleServiceImpl.java" />
      <jump line="661" column="61" filename="$USER_HOME$/data/code/online-classroom/online-classroom-core/src/main/java/com/yunzainfo/oa/onlineclassroom/service/impl/BaseScheduleServiceImpl.java" />
      <jump line="35" column="21" filename="$USER_HOME$/data/code/video-library/src/main/java/com/yunzainfo/cloud/vlib/entity/FileStorage.java" />
      <jump line="49" column="30" filename="$USER_HOME$/data/code/cloud/common/src/main/java/com/yunzainfo/cloud/common/config/YunzaiFeignConfiguration.java" />
      <jump line="41" column="4" filename="$USER_HOME$/data/code/cloud/common/src/main/java/com/yunzainfo/cloud/common/config/YunzaiRedisTokenStore.java" />
      <jump line="192" column="4" filename="$USER_HOME$/data/code/cloud/common/src/main/java/com/yunzainfo/cloud/common/config/YunzaiRedisTokenStore.java" />
      <jump line="284" column="54" filename="$USER_HOME$/data/code/cloud/common/src/main/java/com/yunzainfo/cloud/common/config/YunzaiRedisTokenStore.java" />
      <jump line="88" column="4" filename="$USER_HOME$/data/code/cloud/common/src/main/java/com/yunzainfo/cloud/common/util/AspectUtil.java" />
      <jump line="84" column="35" filename="$USER_HOME$/data/code/cloud/common/src/main/java/com/yunzainfo/cloud/common/util/AspectUtil.java" />
      <jump line="20" column="21" filename="$USER_HOME$/data/code/react-auth/src/models/user.js" />
      <jump line="59" column="18" filename="$USER_HOME$/data/code/react-auth/src/pages/Video/Me.js" />
      <jump line="671" column="27" filename="$USER_HOME$/data/code/react-auth/src/pages/Video/Me.js" />
      <jump line="149" column="34" filename="$USER_HOME$/data/code/react-auth/src/pages/Video/Me.js" />
      <jump line="172" column="52" filename="$USER_HOME$/data/code/video-library/src/main/java/com/yunzainfo/cloud/vlib/service/impl/AliyunFileServiceImpl.java" />
      <jump line="449" column="31" filename="$USER_HOME$/data/code/react-auth/src/pages/Video/Admin.js" />
      <jump line="10" column="0" filename="$USER_HOME$/data/code/react-auth/src/services/video/admin.js" />
      <jump line="64" column="22" filename="$USER_HOME$/data/code/react-auth/src/pages/Video/Admin.js" />
      <jump line="23" column="17" filename="$USER_HOME$/data/code/video-library/src/main/java/com/yunzainfo/cloud/vlib/repository/DeleteCallRepository.java" />
      <jump line="72" column="49" filename="$USER_HOME$/data/code/video-library/src/main/java/com/yunzainfo/cloud/vlib/service/FileService.java" />
      <jump line="67" column="79" filename="$USER_HOME$/data/code/video-library/src/main/java/com/yunzainfo/cloud/vlib/web/FileAppController.java" />
      <jump line="350" column="28" filename="$USER_HOME$/data/code/react-auth/src/pages/Base/Client.js" />
      <jump line="71" column="8" filename="$USER_HOME$/data/code/react-auth/src/pages/Base/Client.js" />
      <jump line="329" column="16" filename="$USER_HOME$/data/code/react-auth/src/pages/Istio/Pods.js" />
      <jump line="76" column="21" filename="$USER_HOME$/data/code/react-auth/src/pages/Istio/Pods.js" />
      <jump line="68" column="46" filename="$USER_HOME$/data/code/sailor/src/test/java/PromeqlTest.java" />
      <jump line="222" column="15" filename="$USER_HOME$/data/code/react-auth/src/pages/Istio/Panel.js" />
      <jump line="235" column="14" filename="$USER_HOME$/data/code/react-auth/src/pages/Istio/Panel.js" />
      <jump line="50" column="38" filename="$USER_HOME$/data/code/react-auth/src/pages/Istio/Panel.js" />
      <jump line="326" column="15" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/RoleGroup.js" />
      <jump line="332" column="2" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/RoleGroup.js" />
      <jump line="318" column="22" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/RoleGroup.js" />
      <jump line="822" column="10" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/RoleGroup.js" />
      <jump line="774" column="27" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="775" column="0" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="525" column="20" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="25" column="51" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="781" column="28" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="30" column="9" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="28" column="56" filename="$USER_HOME$/data/code/cloud/auth-center/src/main/java/com/yunzainfo/cloud/auth/service/impl/RoleUserDeptServiceImpl.java" />
      <jump line="13" column="0" filename="$USER_HOME$/data/code/cloud/auth-center/src/main/java/com/yunzainfo/cloud/auth/service/impl/RoleUserDeptServiceImpl.java" />
      <jump line="269" column="1" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="575" column="29" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="214" column="26" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="35" column="29" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="24" column="0" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="8" column="2" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="0" column="0" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="104" column="32" filename="$USER_HOME$/data/code/react-auth/src/pages/Sys/Role.js" />
      <jump line="217" column="58" filename="$USER_HOME$/data/code/Sche/src/main/java/com/xucheng/schedule/timetable/Timetable.java" />
      <jump line="102" column="121" filename="$USER_HOME$/data/code/Sche/src/main/java/com/xucheng/schedule/web/UserController.java" />
      <jump line="114" column="69" filename="$USER_HOME$/data/code/react-auth/src/pages/Panel/ChartPanel.js" />
      <jump line="60" column="19" filename="$USER_HOME$/data/code/react-auth/src/pages/Base/Panel.js" />
      <jump line="79" column="16" filename="$USER_HOME$/data/code/react-auth/src/layouts/LoadingPage.js" />
      <jump line="238" column="25" filename="$USER_HOME$/data/code/react-auth/src/pages/Istio/Panel.js" />
      <jump line="154" column="19" filename="$USER_HOME$/data/code/cloud/auth-center/src/main/java/com/yunzainfo/cloud/auth/service/impl/BaseRoleServiceImpl.java" />
      <jump line="48" column="23" filename="$USER_HOME$/data/code/react-auth/src/pages/Task/CardList.js" />
      <jump line="43" column="24" filename="$USER_HOME$/data/code/react-auth/src/pages/Task/CardList.js" />
      <jump line="70" column="35" filename="$USER_HOME$/data/code/react-auth/src/pages/Task/CardList.js" />
      <jump line="102" column="3" filename="$USER_HOME$/data/code/react-auth/src/pages/Task/History.js" />
      <jump line="8" column="22" filename="$USER_HOME$/data/code/flowable/flowable-modeler/src/main/java/flowable/modeler/FlowableModelerApplication.java" />
      <jump line="646" column="36" filename="$MAVEN_REPOSITORY$/org/flowable/flowable-engine/6.4.1/flowable-engine-6.4.1.jar!/org/flowable/engine/impl/cfg/ProcessEngineConfigurationImpl.class" />
      <jump line="20" column="70" filename="$USER_HOME$/data/code/flowable/flowable-modeler/src/test/java/com/yunzainfo/cloud/flowable/test/CeleteProcessInstanceCacadeCmd.java" />
      <jump line="7" column="0" filename="$USER_HOME$/data/code/flowable/flowable-modeler/src/test/java/com/yunzainfo/cloud/flowable/test/CeleteProcessInstanceCacadeCmd.java" />
      <jump line="317" column="3" filename="$USER_HOME$/data/code/flowable/flowable-modeler/src/test/java/com/yunzainfo/cloud/flowable/test/RuntimeTaskHistoryServiceTest.java" />
      <jump line="332" column="5" filename="$USER_HOME$/data/code/flowable/flowable-modeler/src/test/java/com/yunzainfo/cloud/flowable/test/RuntimeTaskHistoryServiceTest.java" />
      <jump line="276" column="20" filename="$USER_HOME$/data/code/flowable/flowable-modeler/src/test/java/com/yunzainfo/cloud/flowable/test/TaskGatewayServiceTest.java" />
      <jump line="114" column="4" filename="$USER_HOME$/data/code/react-auth/src/models/formbuilder.js" />
      <jump line="110" column="67" filename="$USER_HOME$/data/code/react-auth/src/pages/FormBuilder/Toolbar.jsx" />
      <jump line="136" column="15" filename="$USER_HOME$/data/code/react-auth/src/pages/Flow/FormData.js" />
      <jump line="64" column="18" filename="$USER_HOME$/data/code/react-auth/src/pages/Flow/FlowDesign.js" />
      <jump line="77" column="10" filename="$USER_HOME$/data/code/flowengine/flowable-engine/flowable/src/main/java/com/yunzainfo/cloud/flowable/service/impl/ActProcessTypeServiceImpl.java" />
      <jump line="14" column="73" filename="$USER_HOME$/data/code/flowengine/flowable-engine/flowable/src/main/java/com/yunzainfo/cloud/flowable/FlowableApplication.java" />
      <jump line="235" column="15" filename="$USER_HOME$/data/code/react-auth/src/pages/Task/Initiate.js" />
      <jump line="117" column="10" filename="$USER_HOME$/data/code/react-auth/src/pages/FormBuilder/rjsf-patch/widgets/FileWidget.js" />
      <jump line="67" column="27" filename="$USER_HOME$/data/code/react-auth/src/pages/Flow/FlowSetting.js" />
      <jump line="66" column="6" filename="$USER_HOME$/data/code/react-auth/src/pages/Flow/FlowSetting.js" />
      <jump line="528" column="80" filename="$USER_HOME$/data/code/react-auth/src/pages/Flow/FlowSetting.js" />
    </jumps>
    <registers>
      <register name="&quot;" type="4">
        <text>{&quot;name&quot;:&quot;张三&quot;,&quot;sex&quot;:18}</text>
      </register>
      <register name="c" type="4">
        <text>msg</text>
      </register>
      <register name="d" type="4">
        <text />
      </register>
      <register name="i" type="4">
        <keys>
          <key char="103" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="108" code="0" mods="0" />
          <key char="65535" code="8" mods="0" />
          <key char="27969" code="0" mods="0" />
          <key char="31243" code="0" mods="0" />
          <key char="21457" code="0" mods="0" />
          <key char="36215" code="0" mods="0" />
          <key char="20154" code="0" mods="0" />
          <key char="114" code="0" mods="0" />
          <key char="102" code="0" mods="0" />
          <key char="114" code="0" mods="0" />
          <key char="102" code="0" mods="0" />
          <key char="20219" code="0" mods="0" />
          <key char="21153" code="0" mods="0" />
          <key char="21019" code="0" mods="0" />
          <key char="24314" code="0" mods="0" />
          <key char="26102" code="0" mods="0" />
          <key char="38388" code="0" mods="0" />
          <key char="65535" code="10" mods="0" />
        </keys>
      </register>
      <register name="*" type="4">
        <text />
      </register>
      <register name="-" type="4">
        <text>depts</text>
      </register>
      <register name="/" type="4">
        <text encoding="base64">XDwiXD4=</text>
      </register>
      <register name="0" type="4">
        <text encoding="base64">ICAgIHByb3RlY3RlZCBzdGF0aWMgZmluYWwgTG9nZ2VyIExPR0dFUiA9IExvZ2dlckZhY3RvcnkuZ2V0TG9nZ2VyKEJwbW5Kc29uQ29udmVydGVyLmNsYXNzKTsKICAgIHByb3RlY3RlZCBPYmplY3RNYXBwZXIgb2JqZWN0TWFwcGVyID0gbmV3IE9iamVjdE1hcHBlcigpOwogICAgcHJvdGVjdGVkIHN0YXRpYyBNYXA8Q2xhc3M8PyBleHRlbmRzIEJhc2VFbGVtZW50PiwgQ2xhc3M8PyBleHRlbmRzIEJhc2VCcG1uSnNvbkNvbnZlcnRlcj4+IGNvbnZlcnRlcnNUb0pzb25NYXAgPSBuZXcgSGFzaE1hcCgpOwogICAgcHJvdGVjdGVkIHN0YXRpYyBNYXA8U3RyaW5nLCBDbGFzczw/IGV4dGVuZHMgQmFzZUJwbW5Kc29uQ29udmVydGVyPj4gY29udmVydGVyc1RvQnBtbk1hcCA9IG5ldyBIYXNoTWFwKCk7CiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIFN0cmluZyBNT0RFTEVSX05BTUVTUEFDRSA9ICJodHRwOi8vZmxvd2FibGUub3JnL21vZGVsZXIiOwogICAgcHJvdGVjdGVkIHN0YXRpYyBmaW5hbCBEYXRlRm9ybWF0IGRlZmF1bHRGb3JtYXQgPSBuZXcgU2ltcGxlRGF0ZUZvcm1hdCgieXl5eU1NZGRISG1tc3MiKTsKICAgIHByb3RlY3RlZCBzdGF0aWMgZmluYWwgRGF0ZUZvcm1hdCBlbnRGb3JtYXQgPSBuZXcgU2ltcGxlRGF0ZUZvcm1hdCgieXl5eU1NZGRISG1tc3NTU1MiKTsKICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIExpc3Q8U3RyaW5nPiBESV9DSVJDTEVTOwogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgTGlzdDxTdHJpbmc+IERJX1JFQ1RBTkdMRVM7CiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBMaXN0PFN0cmluZz4gRElfR0FURVdBWTsKICAgIHByb3RlY3RlZCBkb3VibGUgbGluZVdpZHRoID0gMC4wNUQ7CgogICAgcHVibGljIEJwbW5Kc29uQ29udmVydGVyKCkgewogICAgfQoKICAgIHB1YmxpYyBPYmplY3ROb2RlIGNvbnZlcnRUb0pzb24oQnBtbk1vZGVsIG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29udmVydFRvSnNvbihtb2RlbCwgKE1hcCludWxsLCAoTWFwKW51bGwpOwogICAgfQoKICAgIHB1YmxpYyBPYmplY3ROb2RlIGNvbnZlcnRUb0pzb24oQnBtbk1vZGVsIG1vZGVsLCBNYXA8U3RyaW5nLCBNb2RlbEluZm8+IGZvcm1LZXlNYXAsIE1hcDxTdHJpbmcsIE1vZGVsSW5mbz4gZGVjaXNpb25UYWJsZUtleU1hcCkgewogICAgICAgIE9iamVjdE5vZGUgbW9kZWxOb2RlID0gdGhpcy5vYmplY3RNYXBwZXIuY3JlYXRlT2JqZWN0Tm9kZSgpOwogICAgICAgIGRvdWJsZSBtYXhYID0gMC4wRDsKICAgICAgICBkb3VibGUgbWF4WSA9IDAuMEQ7CiAgICAgICAgSXRlcmF0b3IgdmFyOSA9IG1vZGVsLmdldExvY2F0aW9uTWFwKCkudmFsdWVzKCkuaXRlcmF0b3IoKTsKCiAgICAgICAgd2hpbGUodmFyOS5oYXNOZXh0KCkpIHsKICAgICAgICAgICAgR3JhcGhpY0luZm8gZmxvd0luZm8gPSAoR3JhcGhpY0luZm8pdmFyOS5uZXh0KCk7CiAgICAgICAgICAgIGlmIChmbG93SW5mby5nZXRYKCkgKyBmbG93SW5mby5nZXRXaWR0aCgpID4gbWF4WCkgewogICAgICAgICAgICAgICAgbWF4WCA9IGZsb3dJbmZvLmdldFgoKSArIGZsb3dJbmZvLmdldFdpZHRoKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmbG93SW5mby5nZXRZKCkgKyBmbG93SW5mby5nZXRIZWlnaHQoKSA+IG1heFkpIHsKICAgICAgICAgICAgICAgIG1heFkgPSBmbG93SW5mby5nZXRZKCkgKyBmbG93SW5mby5nZXRIZWlnaHQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbWF4WCArPSA1MC4wRDsKICAgICAgICBtYXhZICs9IDUwLjBEOwogICAgICAgIGlmIChtYXhYIDwgMTQ4NS4wRCkgewogICAgICAgICAgICBtYXhYID0gMTQ4NS4wRDsKICAgICAgICB9CgogICAgICAgIGlmIChtYXhZIDwgNzAwLjBEKSB7CiAgICAgICAgICAgIG1heFkgPSA3MDAuMEQ7CiAgICAgICAgfQoKICAgICAgICBtb2RlbE5vZGUuc2V0KCJib3VuZHMiLCBCcG1uSnNvbkNvbnZlcnRlclV0aWwuY3JlYXRlQm91bmRzTm9kZShtYXhYLCBtYXhZLCAwLjBELCAwLjBEKSk7CiAgICAgICAgbW9kZWxOb2RlLnB1dCgicmVzb3VyY2VJZCIsICJjYW52YXMiKTsKICAgICAgICBPYmplY3ROb2RlIHN0ZW5jaWxOb2RlID0gdGhpcy5vYmplY3RNYXBwZXIuY3JlYXRlT2JqZWN0Tm9kZSgpOwogICAgICAgIHN0ZW5jaWxOb2RlLnB1dCgiaWQiLCAiQlBNTkRpYWdyYW0iKTsKICAgICAgICBtb2RlbE5vZGUuc2V0KCJzdGVuY2lsIiwgc3RlbmNpbE5vZGUpOwogICAgICAgIE9iamVjdE5vZGUgc3RlbmNpbHNldE5vZGUgPSB0aGlzLm9iamVjdE1hcHBlci5jcmVhdGVPYmplY3ROb2RlKCk7CiAgICAgICAgc3RlbmNpbHNldE5vZGUucHV0KCJuYW1lc3BhY2UiLCAiaHR0cDovL2IzbW4ub3JnL3N0ZW5jaWxzZXQvYnBtbjIuMCMiKTsKICAgICAgICBzdGVuY2lsc2V0Tm9kZS5wdXQoInVybCIsICIuLi9lZGl0b3Ivc3RlbmNpbHNldHMvYnBtbjIuMC9icG1uMi4wLmpzb24iKTsKICAgICAgICBtb2RlbE5vZGUuc2V0KCJzdGVuY2lsc2V0Iiwgc3RlbmNpbHNldE5vZGUpOwogICAgICAgIEFycmF5Tm9kZSBzaGFwZXNBcnJheU5vZGUgPSB0aGlzLm9iamVjdE1hcHBlci5jcmVhdGVBcnJheU5vZGUoKTsKICAgICAgICBQcm9jZXNzIG1haW5Qcm9jZXNzID0gbnVsbDsKICAgICAgICBpZiAobW9kZWwuZ2V0UG9vbHMoKS5zaXplKCkgPiAwKSB7CiAgICAgICAgICAgIG1haW5Qcm9jZXNzID0gbW9kZWwuZ2V0UHJvY2VzcygoKFBvb2wpbW9kZWwuZ2V0UG9vbHMoKS5nZXQoMCkpLmdldElkKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1haW5Qcm9jZXNzID0gbW9kZWwuZ2V0TWFpblByb2Nlc3MoKTsKICAgICAgICB9CgogICAgICAgIE9iamVjdE5vZGUgcHJvcGVydGllc05vZGUgPSB0aGlzLm9iamVjdE1hcHBlci5jcmVhdGVPYmplY3ROb2RlKCk7CiAgICAgICAgaWYgKFN0cmluZ1V0aWxzLmlzTm90RW1wdHkobWFpblByb2Nlc3MuZ2V0SWQoKSkpIHsKICAgICAgICAgICAgcHJvcGVydGllc05vZGUucHV0KCJwcm9jZXNzX2lkIiwgbWFpblByb2Nlc3MuZ2V0SWQoKSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoU3RyaW5nVXRpbHMuaXNOb3RFbXB0eShtYWluUHJvY2Vzcy5nZXROYW1lKCkpKSB7CiAgICAgICAgICAgIHByb3BlcnRpZXNOb2RlLnB1dCgibmFtZSIsIG1haW5Qcm9jZXNzLmdldE5hbWUoKSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoU3RyaW5nVXRpbHMuaXNOb3RFbXB0eShtYWluUHJvY2Vzcy5nZXREb2N1bWVudGF0aW9uKCkpKSB7CiAgICAgICAgICAgIHByb3BlcnRpZXNOb2RlLnB1dCgiZG9jdW1lbnRhdGlvbiIsIG1haW5Qcm9jZXNzLmdldERvY3VtZW50YXRpb24oKSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIW1haW5Qcm9jZXNzLmlzRXhlY3V0YWJsZSgpKSB7CiAgICAgICAgICAgIHByb3BlcnRpZXNOb2RlLnB1dCgiaXNleGVjdXRhYmxlIiwgImZhbHNlIik7CiAgICAgICAgfQoKICAgICAgICBpZiAoU3RyaW5nVXRpbHMuaXNOb25lRW1wdHkobmV3IENoYXJTZXF1ZW5jZVtde21vZGVsLmdldFRhcmdldE5hbWVzcGFjZSgpfSkpIHsKICAgICAgICAgICAgcHJvcGVydGllc05vZGUucHV0KCJwcm9jZXNzX25hbWVzcGFjZSIsIG1vZGVsLmdldFRhcmdldE5hbWVzcGFjZSgpKTsKICAgICAgICB9CgogICAgICAgIGlmIChDb2xsZWN0aW9uVXRpbHMuaXNOb3RFbXB0eShtYWluUHJvY2Vzcy5nZXRDYW5kaWRhdGVTdGFydGVyR3JvdXBzKCkpKSB7CiAgICAgICAgICAgIHByb3BlcnRpZXNOb2RlLnB1dCgicHJvY2Vzc19wb3RlbnRpYWxzdGFydGVyZ3JvdXAiLCBTdHJpbmdVdGlscy5qb2luKG1haW5Qcm9jZXNzLmdldENhbmRpZGF0ZVN0YXJ0ZXJHcm91cHMoKSwgIiwiKSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoQ29sbGVjdGlvblV0aWxzLmlzTm90RW1wdHkobWFpblByb2Nlc3MuZ2V0Q2FuZGlkYXRlU3RhcnRlclVzZXJzKCkpKSB7CiAgICAgICAgICAgIHByb3BlcnRpZXNOb2RlLnB1dCgicHJvY2Vzc19wb3RlbnRpYWxzdGFydGVydXNlciIsIFN0cmluZ1V0aWxzLmpvaW4obWFpblByb2Nlc3MuZ2V0Q2FuZGlkYXRlU3RhcnRlclVzZXJzKCksICIsIikpOwogICAgICAgIH0KCiAgICAgICAgaWYgKG1haW5Qcm9jZXNzLmdldEV4dGVuc2lvbkVsZW1lbnRzKCkuY29udGFpbnNLZXkoImhpc3RvcnlMZXZlbCIpKSB7CiAgICAgICAgICAgIExpc3Q8RXh0ZW5zaW9uRWxlbWVudD4gaGlzdG9yeUV4dGVuc2lvbkVsZW1lbnRzID0gKExpc3QpbWFpblByb2Nlc3MuZ2V0RXh0ZW5zaW9uRWxlbWVudHMoKS5nZXQoImhpc3RvcnlMZXZlbCIpOwogICAgICAgICAgICBpZiAoaGlzdG9yeUV4dGVuc2lvbkVsZW1lbnRzICE9IG51bGwgJiYgaGlzdG9yeUV4dGVuc2lvbkVsZW1lbnRzLnNpemUoKSA+IDApIHsKICAgICAgICAgICAgICAgIFN0cmluZyBoaXN0b3J5TGV2ZWwgPSAoKEV4dGVuc2lvbkVsZW1lbnQpaGlzdG9yeUV4dGVuc2lvbkVsZW1lbnRzLmdldCgwKSkuZ2V0RWxlbWVudFRleHQoKTsKICAgICAgICAgICAgICAgIGlmIChTdHJpbmdVdGlscy5pc05vdEVtcHR5KGhpc3RvcnlMZXZlbCkpIHsKICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzTm9kZS5wdXQoInByb2Nlc3NfaGlzdG9yeWxldmVsIiwgaGlzdG9yeUxldmVsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcHJvcGVydGllc05vZGUucHV0KCJpc2VhZ2VyZXhlY3V0aW9uZmV0Y2giLCBtYWluUHJvY2Vzcy5pc0VuYWJsZUVhZ2VyRXhlY3V0aW9uVHJlZUZldGNoaW5nKCkpOwogICAgICAgIEJwbW5Kc29uQ29udmVydGVyVXRpbC5jb252ZXJ0TWVzc2FnZXNUb0pzb24obW9kZWwuZ2V0TWVzc2FnZXMoKSwgcHJvcGVydGllc05vZGUpOwogICAgICAgIEJwbW5Kc29uQ29udmVydGVyVXRpbC5jb252ZXJ0TGlzdGVuZXJzVG9Kc29uKG1haW5Qcm9jZXNzLmdldEV4ZWN1dGlvbkxpc3RlbmVycygpLCB0cnVlLCBwcm9wZXJ0aWVzTm9kZSk7CiAgICAgICAgQnBtbkpzb25Db252ZXJ0ZXJVdGlsLmNvbnZlcnRFdmVudExpc3RlbmVyc1RvSnNvbihtYWluUHJvY2Vzcy5nZXRFdmVudExpc3RlbmVycygpLCBwcm9wZXJ0aWVzTm9kZSk7CiAgICAgICAgQnBtbkpzb25Db252ZXJ0ZXJVdGlsLmNvbnZlcnRTaWduYWxEZWZpbml0aW9uc1RvSnNvbihtb2RlbCwgcHJvcGVydGllc05vZGUpOwogICAgICAgIEJwbW5Kc29uQ29udmVydGVyVXRpbC5jb252ZXJ0TWVzc2FnZXNUb0pzb24obW9kZWwsIHByb3BlcnRpZXNOb2RlKTsKICAgICAgICBpZiAoQ29sbGVjdGlvblV0aWxzLmlzTm90RW1wdHkobWFpblByb2Nlc3MuZ2V0RGF0YU9iamVjdHMoKSkpIHsKICAgICAgICAgICAgQnBtbkpzb25Db252ZXJ0ZXJVdGlsLmNvbnZlcnREYXRhUHJvcGVydGllc1RvSnNvbihtYWluUHJvY2Vzcy5nZXREYXRhT2JqZWN0cygpLCBwcm9wZXJ0aWVzTm9kZSk7CiAgICAgICAgfQoKICAgICAgICBtb2RlbE5vZGUuc2V0KCJwcm9wZXJ0aWVzIiwgcHJvcGVydGllc05vZGUpOwogICAgICAgIGJvb2xlYW4gcG9vbEhhc0RJID0gZmFsc2U7CiAgICAgICAgUG9vbCBwb29sOwogICAgICAgIEdyYXBoaWNJbmZvIHBvb2xHcmFwaGljSW5mbzsKICAgICAgICBJdGVyYXRvciB2YXIzNDsKICAgICAgICBpZiAobW9kZWwuZ2V0UG9vbHMoKS5zaXplKCkgPiAwKSB7CiAgICAgICAgICAgIHZhcjM0ID0gbW9kZWwuZ2V0UG9vbHMoKS5pdGVyYXRvcigpOwoKICAgICAgICAgICAgd2hpbGUodmFyMzQuaGFzTmV4dCgpKSB7CiAgICAgICAgICAgICAgICBwb29sID0gKFBvb2wpdmFyMzQubmV4dCgpOwogICAgICAgICAgICAgICAgcG9vbEdyYXBoaWNJbmZvID0gbW9kZWwuZ2V0R3JhcGhpY0luZm8ocG9vbC5nZXRJZCgpKTsKICAgICAgICAgICAgICAgIGlmIChwb29sR3JhcGhpY0luZm8gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHBvb2xIYXNESSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChtb2RlbC5nZXRQb29scygpLnNpemUoKSA+IDAgJiYgcG9vbEhhc0RJKSB7CiAgICAgICAgICAgIHZhcjM0ID0gbW9kZWwuZ2V0UG9vbHMoKS5pdGVyYXRvcigpOwoKICAgICAgICAgICAgbGFiZWwxNTQ6CiAgICAgICAgICAgIHdoaWxlKHRydWUpIHsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXZhcjM0Lmhhc05leHQoKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NNZXNzYWdlRmxvd3MobW9kZWwsIHNoYXBlc0FycmF5Tm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGxhYmVsMTU0OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcG9vbCA9IChQb29sKXZhcjM0Lm5leHQoKTsKICAgICAgICAgICAgICAgICAgICBwb29sR3JhcGhpY0luZm8gPSBtb2RlbC5nZXRHcmFwaGljSW5mbyhwb29sLmdldElkKCkpOwogICAgICAgICAgICAgICAgfSB3aGlsZShwb29sR3JhcGhpY0luZm8gPT0gbnVsbCk7CgogICAgICAgICAgICAgICAgT2JqZWN0Tm9kZSBwb29sTm9kZSA9IEJwbW5Kc29uQ29udmVydGVyVXRpbC5jcmVhdGVDaGlsZFNoYXBlKHBvb2wuZ2V0SWQoKSwgIlBvb2wiLCBwb29sR3JhcGhpY0luZm8uZ2V0WCgpICsgcG9vbEdyYXBoaWNJbmZvLmdldFdpZHRoKCksIHBvb2xHcmFwaGljSW5mby5nZXRZKCkgKyBwb29sR3JhcGhpY0luZm8uZ2V0SGVpZ2h0KCksIHBvb2xHcmFwaGljSW5mby5nZXRYKCksIHBvb2xHcmFwaGljSW5mby5nZXRZKCkpOwogICAgICAgICAgICAgICAgc2hhcGVzQXJyYXlOb2RlLmFkZChwb29sTm9kZSk7CiAgICAgICAgICAgICAgICBPYmplY3ROb2RlIHBvb2xQcm9wZXJ0aWVzTm9kZSA9IHRoaXMub2JqZWN0TWFwcGVyLmNyZWF0ZU9iamVjdE5vZGUoKTsKICAgICAgICAgICAgICAgIHBvb2xQcm9wZXJ0aWVzTm9kZS5wdXQoIm92ZXJyaWRlaWQiLCBwb29sLmdldElkKCkpOwogICAgICAgICAgICAgICAgcG9vbFByb3BlcnRpZXNOb2RlLnB1dCgicHJvY2Vzc19pZCIsIHBvb2wuZ2V0UHJvY2Vzc1JlZigpKTsKICAgICAgICAgICAgICAgIGlmICghcG9vbC5pc0V4ZWN1dGFibGUoKSkgewogICAgICAgICAgICAgICAgICAgIHBvb2xQcm9wZXJ0aWVzTm9kZS5wdXQoImlzZXhlY3V0YWJsZSIsICJmYWxzZSIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChTdHJpbmdVdGlscy5pc05vdEVtcHR5KHBvb2wuZ2V0TmFtZSgpKSkgewogICAgICAgICAgICAgICAgICAgIHBvb2xQcm9wZXJ0aWVzTm9kZS5wdXQoIm5hbWUiLCBwb29sLmdldE5hbWUoKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcG9vbE5vZGUuc2V0KCJwcm9wZXJ0aWVzIiwgcG9vbFByb3BlcnRpZXNOb2RlKTsKICAgICAgICAgICAgICAgIEFycmF5Tm9kZSBsYW5lU2hhcGVzQXJyYXlOb2RlID0gdGhpcy5vYmplY3RNYXBwZXIuY3JlYXRlQXJyYXlOb2RlKCk7CiAgICAgICAgICAgICAgICBwb29sTm9kZS5zZXQoImNoaWxkU2hhcGVzIiwgbGFuZVNoYXBlc0FycmF5Tm9kZSk7CiAgICAgICAgICAgICAgICBBcnJheU5vZGUgb3V0Z29pbmdBcnJheU5vZGUgPSB0aGlzLm9iamVjdE1hcHBlci5jcmVhdGVBcnJheU5vZGUoKTsKICAgICAgICAgICAgICAgIHBvb2xOb2RlLnNldCgib3V0Z29pbmciLCBvdXRnb2luZ0FycmF5Tm9kZSk7CiAgICAgICAgICAgICAgICBQcm9jZXNzIHByb2Nlc3MgPSBtb2RlbC5nZXRQcm9jZXNzKHBvb2wuZ2V0SWQoKSk7CiAgICAgICAgICAgICAgICBpZiAocHJvY2VzcyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgTWFwPFN0cmluZywgQXJyYXlOb2RlPiBsYW5lTWFwID0gbmV3IEhhc2hNYXAoKTsKICAgICAgICAgICAgICAgICAgICBJdGVyYXRvciB2YXIyNCA9IHByb2Nlc3MuZ2V0TGFuZXMoKS5pdGVyYXRvcigpOwoKICAgICAgICAgICAgICAgICAgICBPYmplY3ROb2RlIGxhbmVQcm9wZXJ0aWVzTm9kZTsKICAgICAgICAgICAgICAgICAgICB3aGlsZSh2YXIyNC5oYXNOZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgTGFuZSBsYW5lID0gKExhbmUpdmFyMjQubmV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICBHcmFwaGljSW5mbyBsYW5lR3JhcGhpY0luZm8gPSBtb2RlbC5nZXRHcmFwaGljSW5mbyhsYW5lLmdldElkKCkpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFuZUdyYXBoaWNJbmZvICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdE5vZGUgbGFuZU5vZGUgPSBCcG1uSnNvbkNvbnZlcnRlclV0aWwuY3JlYXRlQ2hpbGRTaGFwZShsYW5lLmdldElkKCksICJMYW5lIiwgbGFuZUdyYXBoaWNJbmZvLmdldFgoKSArIGxhbmVHcmFwaGljSW5mby5nZXRXaWR0aCgpIC0gcG9vbEdyYXBoaWNJbmZvLmdldFgoKSwgbGFuZUdyYXBoaWNJbmZvLmdldFkoKSArIGxhbmVHcmFwaGljSW5mby5nZXRIZWlnaHQoKSAtIHBvb2xHcmFwaGljSW5mby5nZXRZKCksIGxhbmVHcmFwaGljSW5mby5nZXRYKCkgLSBwb29sR3JhcGhpY0luZm8uZ2V0WCgpLCBsYW5lR3JhcGhpY0luZm8uZ2V0WSgpIC0gcG9vbEdyYXBoaWNJbmZvLmdldFkoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYW5lU2hhcGVzQXJyYXlOb2RlLmFkZChsYW5lTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYW5lUHJvcGVydGllc05vZGUgPSB0aGlzLm9iamVjdE1hcHBlci5jcmVhdGVPYmplY3ROb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYW5lUHJvcGVydGllc05vZGUucHV0KCJvdmVycmlkZWlkIiwgbGFuZS5nZXRJZCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChTdHJpbmdVdGlscy5pc05vdEVtcHR5KGxhbmUuZ2V0TmFtZSgpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhbmVQcm9wZXJ0aWVzTm9kZS5wdXQoIm5hbWUiLCBsYW5lLmdldE5hbWUoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFuZU5vZGUuc2V0KCJwcm9wZXJ0aWVzIiwgbGFuZVByb3BlcnRpZXNOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFycmF5Tm9kZSBlbGVtZW50U2hhcGVzQXJyYXlOb2RlID0gdGhpcy5vYmplY3RNYXBwZXIuY3JlYXRlQXJyYXlOb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYW5lTm9kZS5zZXQoImNoaWxkU2hhcGVzIiwgZWxlbWVudFNoYXBlc0FycmF5Tm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYW5lTm9kZS5zZXQoIm91dGdvaW5nIiwgdGhpcy5vYmplY3RNYXBwZXIuY3JlYXRlQXJyYXlOb2RlKCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFuZU1hcC5wdXQobGFuZS5nZXRJZCgpLCBlbGVtZW50U2hhcGVzQXJyYXlOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyMjQgPSBwcm9jZXNzLmdldEZsb3dFbGVtZW50cygpLml0ZXJhdG9yKCk7CgogICAgICAgICAgICAgICAgICAgIGxhYmVsMTQwOgogICAgICAgICAgICAgICAgICAgIHdoaWxlKHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgRmxvd0VsZW1lbnQgZmxvd0VsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIExhbmUgbGFuZUZvckVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIEdyYXBoaWNJbmZvIGxhbmVHcmFwaGljSW5mbzsKICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YXIyNC5oYXNOZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NBcnRpZmFjdHMocHJvY2VzcywgbW9kZWwsIHNoYXBlc0FycmF5Tm9kZSwgMC4wRCwgMC4wRCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgbGFiZWwxNDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvd0VsZW1lbnQgPSAoRmxvd0VsZW1lbnQpdmFyMjQubmV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFuZUZvckVsZW1lbnQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFuZUdyYXBoaWNJbmZvID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhbmVQcm9wZXJ0aWVzTm9kZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGbG93RWxlbWVudCBsb29rRm9yRWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbG93RWxlbWVudCBpbnN0YW5jZW9mIFNlcXVlbmNlRmxvdykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNlcXVlbmNlRmxvdyBzZXF1ZW5jZUZsb3cgPSAoU2VxdWVuY2VGbG93KWZsb3dFbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvb2tGb3JFbGVtZW50ID0gbW9kZWwuZ2V0Rmxvd0VsZW1lbnQoc2VxdWVuY2VGbG93LmdldFNvdXJjZVJlZigpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9va0ZvckVsZW1lbnQgPSBmbG93RWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBJdGVyYXRvciB2YXI0MiA9IHByb2Nlc3MuZ2V0TGFuZXMoKS5pdGVyYXRvcigpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKHZhcjQyLmhhc05leHQoKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExhbmUgbGFuZSA9IChMYW5lKXZhcjQyLm5leHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFuZS5nZXRGbG93UmVmZXJlbmNlcygpLmNvbnRhaW5zKGxvb2tGb3JFbGVtZW50LmdldElkKCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhbmVHcmFwaGljSW5mbyA9IG1vZGVsLmdldEdyYXBoaWNJbmZvKGxhbmUuZ2V0SWQoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYW5lR3JhcGhpY0luZm8gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFuZUZvckVsZW1lbnQgPSBsYW5lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSghKGZsb3dFbGVtZW50IGluc3RhbmNlb2YgU2VxdWVuY2VGbG93KSAmJiBsYW5lRm9yRWxlbWVudCA9PSBudWxsKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc0Zsb3dFbGVtZW50KGZsb3dFbGVtZW50LCBwcm9jZXNzLCBtb2RlbCwgKEFycmF5Tm9kZSlsYW5lTWFwLmdldChsYW5lRm9yRWxlbWVudC5nZXRJZCgpKSwgZm9ybUtleU1hcCwgZGVjaXNpb25UYWJsZUtleU1hcCwgbGFuZUdyYXBoaWNJbmZvLmdldFgoKSwgbGFuZUdyYXBoaWNJbmZvLmdldFkoKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIEl0ZXJhdG9yIHZhcjM1ID0gbW9kZWwuZ2V0TWVzc2FnZUZsb3dzKCkudmFsdWVzKCkuaXRlcmF0b3IoKTsKCiAgICAgICAgICAgICAgICB3aGlsZSh2YXIzNS5oYXNOZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgICBNZXNzYWdlRmxvdyBtZXNzYWdlRmxvdyA9IChNZXNzYWdlRmxvdyl2YXIzNS5uZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2VGbG93LmdldFNvdXJjZVJlZigpLmVxdWFscyhwb29sLmdldElkKCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG91dGdvaW5nQXJyYXlOb2RlLmFkZChCcG1uSnNvbkNvbnZlcnRlclV0aWwuY3JlYXRlUmVzb3VyY2VOb2RlKG1lc3NhZ2VGbG93LmdldElkKCkpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnByb2Nlc3NGbG93RWxlbWVudHMobW9kZWwuZ2V0TWFpblByb2Nlc3MoKSwgbW9kZWwsIHNoYXBlc0FycmF5Tm9kZSwgZm9ybUtleU1hcCwgZGVjaXNpb25UYWJsZUtleU1hcCwgMC4wRCwgMC4wRCk7CiAgICAgICAgICAgIHRoaXMucHJvY2Vzc01lc3NhZ2VGbG93cyhtb2RlbCwgc2hhcGVzQXJyYXlOb2RlKTsKICAgICAgICB9CgogICAgICAgIG1vZGVsTm9kZS5zZXQoImNoaWxkU2hhcGVzIiwgc2hhcGVzQXJyYXlOb2RlKTsKICAgICAgICByZXR1cm4gbW9kZWxOb2RlOwogICAgfQoKICAgIHB1YmxpYyB2b2lkIHByb2Nlc3NGbG93RWxlbWVudHMoRmxvd0VsZW1lbnRzQ29udGFpbmVyIGNvbnRhaW5lciwgQnBtbk1vZGVsIG1vZGVsLCBBcnJheU5vZGUgc2hhcGVzQXJyYXlOb2RlLCBNYXA8U3RyaW5nLCBNb2RlbEluZm8+IGZvcm1LZXlNYXAsIE1hcDxTdHJpbmcsIE1vZGVsSW5mbz4gZGVjaXNpb25UYWJsZUtleU1hcCwgZG91YmxlIHN1YlByb2Nlc3NYLCBkb3VibGUgc3ViUHJvY2Vzc1kpIHsKICAgICAgICBJdGVyYXRvciB2YXIxMCA9IGNvbnRhaW5lci5nZXRGbG93RWxlbWVudHMoKS5pdGVyYXRvcigpOwoKICAgICAgICB3aGlsZSh2YXIxMC5oYXNOZXh0KCkpIHsKICAgICAgICAgICAgRmxvd0VsZW1lbnQgZmxvd0VsZW1lbnQgPSAoRmxvd0VsZW1lbnQpdmFyMTAubmV4dCgpOwogICAgICAgICAgICB0aGlzLnByb2Nlc3NGbG93RWxlbWVudChmbG93RWxlbWVudCwgY29udGFpbmVyLCBtb2RlbCwgc2hhcGVzQXJyYXlOb2RlLCBmb3JtS2V5TWFwLCBkZWNpc2lvblRhYmxlS2V5TWFwLCBzdWJQcm9jZXNzWCwgc3ViUHJvY2Vzc1kpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5wcm9jZXNzQXJ0aWZhY3RzKGNvbnRhaW5lciwgbW9kZWwsIHNoYXBlc0FycmF5Tm9kZSwgc3ViUHJvY2Vzc1gsIHN1YlByb2Nlc3NZKTsKICAgIH0KCiAgICBwcm90ZWN0ZWQgdm9pZCBwcm9jZXNzRmxvd0VsZW1lbnQoRmxvd0VsZW1lbnQgZmxvd0VsZW1lbnQsIEZsb3dFbGVtZW50c0NvbnRhaW5lciBjb250YWluZXIsIEJwbW5Nb2RlbCBtb2RlbCwgQXJyYXlOb2RlIHNoYXBlc0FycmF5Tm9kZSwgTWFwPFN0cmluZywgTW9kZWxJbmZvPiBmb3JtS2V5TWFwLCBNYXA8U3RyaW5nLCBNb2RlbEluZm8+IGRlY2lzaW9uVGFibGVLZXlNYXAsIGRvdWJsZSBjb250YWluZXJYLCBkb3VibGUgY29udGFpbmVyWSkgewogICAgICAgIENsYXNzPD8gZXh0ZW5kcyBCYXNlQnBtbkpzb25Db252ZXJ0ZXI+IGNvbnZlcnRlciA9IChDbGFzcyljb252ZXJ0ZXJzVG9Kc29uTWFwLmdldChmbG93RWxlbWVudC5nZXRDbGFzcygpKTsKICAgICAgICBpZiAoY29udmVydGVyICE9IG51bGwpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIEJhc2VCcG1uSnNvbkNvbnZlcnRlciBjb252ZXJ0ZXJJbnN0YW5jZSA9IChCYXNlQnBtbkpzb25Db252ZXJ0ZXIpY29udmVydGVyLm5ld0luc3RhbmNlKCk7CiAgICAgICAgICAgICAgICBpZiAoY29udmVydGVySW5zdGFuY2UgaW5zdGFuY2VvZiBGb3JtS2V5QXdhcmVDb252ZXJ0ZXIpIHsKICAgICAgICAgICAgICAgICAgICAoKEZvcm1LZXlBd2FyZUNvbnZlcnRlciljb252ZXJ0ZXJJbnN0YW5jZSkuc2V0Rm9ybUtleU1hcChmb3JtS2V5TWFwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoY29udmVydGVySW5zdGFuY2UgaW5zdGFuY2VvZiBEZWNpc2lvblRhYmxlS2V5QXdhcmVDb252ZXJ0ZXIpIHsKICAgICAgICAgICAgICAgICAgICAoKERlY2lzaW9uVGFibGVLZXlBd2FyZUNvbnZlcnRlciljb252ZXJ0ZXJJbnN0YW5jZSkuc2V0RGVjaXNpb25UYWJsZUtleU1hcChkZWNpc2lvblRhYmxlS2V5TWFwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb252ZXJ0ZXJJbnN0YW5jZS5jb252ZXJ0VG9Kc29uKGZsb3dFbGVtZW50LCB0aGlzLCBtb2RlbCwgY29udGFpbmVyLCBzaGFwZXNBcnJheU5vZGUsIGNvbnRhaW5lclgsIGNvbnRhaW5lclkpOwogICAgICAgICAgICB9IGNhdGNoIChFeGNlcHRpb24gdmFyMTMpIHsKICAgICAgICAgICAgICAgIExPR0dFUi5lcnJvcigiRXJyb3IgY29udmVydGluZyB7fSIsIGZsb3dFbGVtZW50LCB2YXIxMyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfQoKICAgIHByb3RlY3RlZCB2b2lkIHByb2Nlc3NBcnRpZmFjdHMoRmxvd0VsZW1lbnRzQ29udGFpbmVyIGNvbnRhaW5lciwgQnBtbk1vZGVsIG1vZGVsLCBBcnJheU5vZGUgc2hhcGVzQXJyYXlOb2RlLCBkb3VibGUgY29udGFpbmVyWCwgZG91YmxlIGNvbnRhaW5lclkpIHsKICAgICAgICBJdGVyYXRvciB2YXI4ID0gY29udGFpbmVyLmdldEFydGlmYWN0cygpLml0ZXJhdG9yKCk7CgogICAgICAgIHdoaWxlKHZhcjguaGFzTmV4dCgpKSB7CiAgICAgICAgICAgIEFydGlmYWN0IGFydGlmYWN0ID0gKEFydGlmYWN0KXZhcjgubmV4dCgpOwogICAgICAgICAgICBDbGFzczw/IGV4dGVuZHMgQmFzZUJwbW5Kc29uQ29udmVydGVyPiBjb252ZXJ0ZXIgPSAoQ2xhc3MpY29udmVydGVyc1RvSnNvbk1hcC5nZXQoYXJ0aWZhY3QuZ2V0Q2xhc3MoKSk7CiAgICAgICAgICAgIGlmIChjb252ZXJ0ZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAoKEJhc2VCcG1uSnNvbkNvbnZlcnRlciljb252ZXJ0ZXIubmV3SW5zdGFuY2UoKSkuY29udmVydFRvSnNvbihhcnRpZmFjdCwgdGhpcywgbW9kZWwsIGNvbnRhaW5lciwgc2hhcGVzQXJyYXlOb2RlLCBjb250YWluZXJYLCBjb250YWluZXJZKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKEV4Y2VwdGlvbiB2YXIxMikgewogICAgICAgICAgICAgICAgICAgIExPR0dFUi5lcnJvcigiRXJyb3IgY29udmVydGluZyB7fSIsIGFydGlmYWN0LCB2YXIxMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfQoKICAgIHByb3RlY3RlZCB2b2lkIHByb2Nlc3NNZXNzYWdlRmxvd3MoQnBtbk1vZGVsIG1vZGVsLCBBcnJheU5vZGUgc2hhcGVzQXJyYXlOb2RlKSB7CiAgICAgICAgSXRlcmF0b3IgdmFyMyA9IG1vZGVsLmdldE1lc3NhZ2VGbG93cygpLnZhbHVlcygpLml0ZXJhdG9yKCk7CgogICAgICAgIHdoaWxlKHZhcjMuaGFzTmV4dCgpKSB7CiAgICAgICAgICAgIE1lc3NhZ2VGbG93IG1lc3NhZ2VGbG93ID0gKE1lc3NhZ2VGbG93KXZhcjMubmV4dCgpOwogICAgICAgICAgICBNZXNzYWdlRmxvd0pzb25Db252ZXJ0ZXIganNvbkNvbnZlcnRlciA9IG5ldyBNZXNzYWdlRmxvd0pzb25Db252ZXJ0ZXIoKTsKICAgICAgICAgICAganNvbkNvbnZlcnRlci5jb252ZXJ0VG9Kc29uKG1lc3NhZ2VGbG93LCB0aGlzLCBtb2RlbCwgKEZsb3dFbGVtZW50c0NvbnRhaW5lciludWxsLCBzaGFwZXNBcnJheU5vZGUsIDAuMEQsIDAuMEQpOwogICAgICAgIH0KCiAgICB9CgogICAgcHVibGljIEJwbW5Nb2RlbCBjb252ZXJ0VG9CcG1uTW9kZWwoSnNvbk5vZGUgbW9kZWxOb2RlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29udmVydFRvQnBtbk1vZGVsKG1vZGVsTm9kZSwgKE1hcCludWxsLCAoTWFwKW51bGwpOwogICAgfQoKICAgIHB1YmxpYyBCcG1uTW9kZWwgY29udmVydFRvQnBtbk1vZGVsKEpzb25Ob2RlIG1vZGVsTm9kZSwgTWFwPFN0cmluZywgU3RyaW5nPiBmb3JtS2V5TWFwLCBNYXA8U3RyaW5nLCBTdHJpbmc+IGRlY2lzaW9uVGFibGVLZXlNYXApIHsKICAgICAgICBCcG1uTW9kZWwgYnBtbk1vZGVsID0gbmV3IEJwbW5Nb2RlbCgpOwogICAgICAgIGJwbW5Nb2RlbC5zZXRUYXJnZXROYW1lc3BhY2UoImh0dHA6Ly9mbG93YWJsZS5vcmcvdGVzdCIpOwogICAgICAgIE1hcDxTdHJpbmcsIEpzb25Ob2RlPiBzaGFwZU1hcCA9IG5ldyBIYXNoTWFwKCk7CiAgICAgICAgTWFwPFN0cmluZywgSnNvbk5vZGU+IHNvdXJjZVJlZk1hcCA9IG5ldyBIYXNoTWFwKCk7CiAgICAgICAgTWFwPFN0cmluZywgSnNvbk5vZGU+IGVkZ2VNYXAgPSBuZXcgSGFzaE1hcCgpOwogICAgICAgIE1hcDxTdHJpbmcsIExpc3Q8SnNvbk5vZGU+PiBzb3VyY2VBbmRUYXJnZXRNYXAgPSBuZXcgSGFzaE1hcCgpOwogICAgICAgIHRoaXMucmVhZFNoYXBlREkobW9kZWxOb2RlLCAwLjBELCAwLjBELCBzaGFwZU1hcCwgc291cmNlUmVmTWFwLCBicG1uTW9kZWwpOwogICAgICAgIHRoaXMuZmlsdGVyQWxsRWRnZXMobW9kZWxOb2RlLCBlZGdlTWFwLCBzb3VyY2VBbmRUYXJnZXRNYXAsIHNoYXBlTWFwLCBzb3VyY2VSZWZNYXApOwogICAgICAgIHRoaXMucmVhZEVkZ2VESShlZGdlTWFwLCBzb3VyY2VBbmRUYXJnZXRNYXAsIGJwbW5Nb2RlbCk7CiAgICAgICAgQXJyYXlOb2RlIHNoYXBlc0FycmF5Tm9kZSA9IChBcnJheU5vZGUpbW9kZWxOb2RlLmdldCgiY2hpbGRTaGFwZXMiKTsKICAgICAgICBpZiAoc2hhcGVzQXJyYXlOb2RlICE9IG51bGwgJiYgc2hhcGVzQXJyYXlOb2RlLnNpemUoKSAhPSAwKSB7CiAgICAgICAgICAgIGJvb2xlYW4gbm9uRW1wdHlQb29sRm91bmQgPSBmYWxzZTsKICAgICAgICAgICAgTWFwPFN0cmluZywgTGFuZT4gZWxlbWVudEluTGFuZU1hcCA9IG5ldyBIYXNoTWFwKCk7CiAgICAgICAgICAgIEl0ZXJhdG9yIHZhcjEyID0gc2hhcGVzQXJyYXlOb2RlLml0ZXJhdG9yKCk7CgogICAgICAgICAgICBsYWJlbDIyOToKICAgICAgICAgICAgd2hpbGUodHJ1ZSkgewogICAgICAgICAgICAgICAgSnNvbk5vZGUgc2hhcGVOb2RlOwogICAgICAgICAgICAgICAgU3RyaW5nIG5hbWVzcGFjZTsKICAgICAgICAgICAgICAgIEpzb25Ob2RlIGV2ZW50TGlzdGVuZXJzTm9kZTsKICAgICAgICAgICAgICAgIEpzb25Ob2RlIHByb2Nlc3NEYXRhUHJvcGVydGllc05vZGU7CiAgICAgICAgICAgICAgICBMaXN0IGRhdGFPYmplY3RzOwogICAgICAgICAgICAgICAgSXRlcmF0b3IgdmFyMjA7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF2YXIxMi5oYXNOZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgSnNvbk5vZGUgc2lnbmFsRGVmaW5pdGlvbk5vZGUgPSBCcG1uSnNvbkNvbnZlcnRlclV0aWwuZ2V0UHJvcGVydHkoInNpZ25hbGRlZmluaXRpb25zIiwgbW9kZWxOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2lnbmFsRGVmaW5pdGlvbk5vZGUgPSBCcG1uSnNvbkNvbnZlcnRlclV0aWwudmFsaWRhdGVJZk5vZGVJc1RleHR1YWwoc2lnbmFsRGVmaW5pdGlvbk5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICBzaWduYWxEZWZpbml0aW9uTm9kZSA9IEJwbW5Kc29uQ29udmVydGVyVXRpbC52YWxpZGF0ZUlmTm9kZUlzVGV4dHVhbChzaWduYWxEZWZpbml0aW9uTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIEl0ZXJhdG9yIHNpZ25hbERlZmluaXRpb25JdGVyYXRvcjsKICAgICAgICAgICAgICAgICAgICAgICAgSnNvbk5vZGUgcHJvY2Vzc0V4ZWN1dGFibGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmcgaGlzdG9yeUxldmVsOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2lnbmFsRGVmaW5pdGlvbk5vZGUgIT0gbnVsbCAmJiBzaWduYWxEZWZpbml0aW9uTm9kZSBpbnN0YW5jZW9mIEFycmF5Tm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgQXJyYXlOb2RlIHNpZ25hbERlZmluaXRpb25BcnJheU5vZGUgPSAoQXJyYXlOb2RlKXNpZ25hbERlZmluaXRpb25Ob2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2lnbmFsRGVmaW5pdGlvbkl0ZXJhdG9yID0gc2lnbmFsRGVmaW5pdGlvbkFycmF5Tm9kZS5pdGVyYXRvcigpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKHNpZ25hbERlZmluaXRpb25JdGVyYXRvci5oYXNOZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzRXhlY3V0YWJsZU5vZGUgPSAoSnNvbk5vZGUpc2lnbmFsRGVmaW5pdGlvbkl0ZXJhdG9yLm5leHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoaXN0b3J5TGV2ZWwgPSBwcm9jZXNzRXhlY3V0YWJsZU5vZGUuZ2V0KCJpZCIpLmFzVGV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZyBzaWduYWxOYW1lID0gcHJvY2Vzc0V4ZWN1dGFibGVOb2RlLmdldCgibmFtZSIpLmFzVGV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZyBzaWduYWxTY29wZSA9IHByb2Nlc3NFeGVjdXRhYmxlTm9kZS5nZXQoInNjb3BlIikuYXNUZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFN0cmluZ1V0aWxzLmlzTm90RW1wdHkoaGlzdG9yeUxldmVsKSAmJiBTdHJpbmdVdGlscy5pc05vdEVtcHR5KHNpZ25hbE5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNpZ25hbCBzaWduYWwgPSBuZXcgU2lnbmFsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpZ25hbC5zZXRJZChoaXN0b3J5TGV2ZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaWduYWwuc2V0TmFtZShzaWduYWxOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2lnbmFsLnNldFNjb3BlKHNpZ25hbFNjb3BlLnRvTG93ZXJDYXNlKCkuZXF1YWxzKCJwcm9jZXNzaW5zdGFuY2UiKSA/ICJwcm9jZXNzSW5zdGFuY2UiIDogImdsb2JhbCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicG1uTW9kZWwuYWRkU2lnbmFsKHNpZ25hbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmcgZmxvd0lkOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5vbkVtcHR5UG9vbEZvdW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBQcm9jZXNzIHByb2Nlc3MgPSBuZXcgUHJvY2VzcygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnBtbk1vZGVsLmdldFByb2Nlc3NlcygpLmFkZChwcm9jZXNzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3Muc2V0SWQoQnBtbkpzb25Db252ZXJ0ZXJVdGlsLmdldFByb3BlcnR5VmFsdWVBc1N0cmluZygicHJvY2Vzc19pZCIsIG1vZGVsTm9kZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5zZXROYW1lKEJwbW5Kc29uQ29udmVydGVyVXRpbC5nZXRQcm9wZXJ0eVZhbHVlQXNTdHJpbmcoIm5hbWUiLCBtb2RlbE5vZGUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZSA9IEJwbW5Kc29uQ29udmVydGVyVXRpbC5nZXRQcm9wZXJ0eVZhbHVlQXNTdHJpbmcoInByb2Nlc3NfbmFtZXNwYWNlIiwgbW9kZWxOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChTdHJpbmdVdGlscy5pc05vdEVtcHR5KG5hbWVzcGFjZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicG1uTW9kZWwuc2V0VGFyZ2V0TmFtZXNwYWNlKG5hbWVzcGFjZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5zZXREb2N1bWVudGF0aW9uKEJwbW5Kc29uQ29udmVydGVyVXRpbC5nZXRQcm9wZXJ0eVZhbHVlQXNTdHJpbmcoImRvY3VtZW50YXRpb24iLCBtb2RlbE5vZGUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3NFeGVjdXRhYmxlTm9kZSA9IEpzb25Db252ZXJ0ZXJVdGlsLmdldFByb3BlcnR5KCJpc2V4ZWN1dGFibGUiLCBtb2RlbE5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByb2Nlc3NFeGVjdXRhYmxlTm9kZSAhPSBudWxsICYmIFN0cmluZ1V0aWxzLmlzTm90RW1wdHkocHJvY2Vzc0V4ZWN1dGFibGVOb2RlLmFzVGV4dCgpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3Muc2V0RXhlY3V0YWJsZShKc29uQ29udmVydGVyVXRpbC5nZXRQcm9wZXJ0eVZhbHVlQXNCb29sZWFuKCJpc2V4ZWN1dGFibGUiLCBtb2RlbE5vZGUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoaXN0b3J5TGV2ZWwgPSBCcG1uSnNvbkNvbnZlcnRlclV0aWwuZ2V0UHJvcGVydHlWYWx1ZUFzU3RyaW5nKCJwcm9jZXNzX2hpc3RvcnlsZXZlbCIsIG1vZGVsTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoU3RyaW5nVXRpbHMuaXNOb3RFbXB0eShoaXN0b3J5TGV2ZWwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRXh0ZW5zaW9uRWxlbWVudCBoaXN0b3J5RXh0ZW5zaW9uRWxlbWVudCA9IG5ldyBFeHRlbnNpb25FbGVtZW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGlzdG9yeUV4dGVuc2lvbkVsZW1lbnQuc2V0TmFtZSgiaGlzdG9yeUxldmVsIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGlzdG9yeUV4dGVuc2lvbkVsZW1lbnQuc2V0TmFtZXNwYWNlKCJodHRwOi8vZmxvd2FibGUub3JnL2JwbW4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoaXN0b3J5RXh0ZW5zaW9uRWxlbWVudC5zZXROYW1lc3BhY2VQcmVmaXgoImZsb3dhYmxlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGlzdG9yeUV4dGVuc2lvbkVsZW1lbnQuc2V0RWxlbWVudFRleHQoaGlzdG9yeUxldmVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLmFkZEV4dGVuc2lvbkVsZW1lbnQoaGlzdG9yeUV4dGVuc2lvbkVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEJwbW5Kc29uQ29udmVydGVyVXRpbC5jb252ZXJ0SnNvblRvTWVzc2FnZXMobW9kZWxOb2RlLCBicG1uTW9kZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgQnBtbkpzb25Db252ZXJ0ZXJVdGlsLmNvbnZlcnRKc29uVG9MaXN0ZW5lcnMobW9kZWxOb2RlLCBwcm9jZXNzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50TGlzdGVuZXJzTm9kZSA9IEJwbW5Kc29uQ29udmVydGVyVXRpbC5nZXRQcm9wZXJ0eSgiZXZlbnRsaXN0ZW5lcnMiLCBtb2RlbE5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50TGlzdGVuZXJzTm9kZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRMaXN0ZW5lcnNOb2RlID0gQnBtbkpzb25Db252ZXJ0ZXJVdGlsLnZhbGlkYXRlSWZOb2RlSXNUZXh0dWFsKGV2ZW50TGlzdGVuZXJzTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQnBtbkpzb25Db252ZXJ0ZXJVdGlsLnBhcnNlRXZlbnRMaXN0ZW5lcnMoZXZlbnRMaXN0ZW5lcnNOb2RlLmdldCgiZXZlbnRMaXN0ZW5lcnMiKSwgcHJvY2Vzcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc0RhdGFQcm9wZXJ0aWVzTm9kZSA9IG1vZGVsTm9kZS5nZXQoInByb3BlcnRpZXMiKS5nZXQoImRhdGFwcm9wZXJ0aWVzIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvY2Vzc0RhdGFQcm9wZXJ0aWVzTm9kZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YU9iamVjdHMgPSBCcG1uSnNvbkNvbnZlcnRlclV0aWwuY29udmVydEpzb25Ub0RhdGFQcm9wZXJ0aWVzKHByb2Nlc3NEYXRhUHJvcGVydGllc05vZGUsIHByb2Nlc3MpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3Muc2V0RGF0YU9iamVjdHMoZGF0YU9iamVjdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZ2V0Rmxvd0VsZW1lbnRzKCkuYWRkQWxsKGRhdGFPYmplY3RzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG93SWQgPSBCcG1uSnNvbkNvbnZlcnRlclV0aWwuZ2V0UHJvcGVydHlWYWx1ZUFzU3RyaW5nKCJwcm9jZXNzX3BvdGVudGlhbHN0YXJ0ZXJ1c2VyIiwgbW9kZWxOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZyBncm91cFN0YXJ0ZXJWYWx1ZSA9IEJwbW5Kc29uQ29udmVydGVyVXRpbC5nZXRQcm9wZXJ0eVZhbHVlQXNTdHJpbmcoInByb2Nlc3NfcG90ZW50aWFsc3RhcnRlcmdyb3VwIiwgbW9kZWxOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFycmF5TGlzdCBncm91cFN0YXJ0ZXJzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nW10gZ3JvdXBTdGFydGVyQXJyYXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoU3RyaW5nVXRpbHMuaXNOb3RFbXB0eShmbG93SWQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBTdGFydGVycyA9IG5ldyBBcnJheUxpc3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cFN0YXJ0ZXJBcnJheSA9IGZsb3dJZC5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwU3RhcnRlcnMuYWRkQWxsKEFycmF5cy5hc0xpc3QoZ3JvdXBTdGFydGVyQXJyYXkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLnNldENhbmRpZGF0ZVN0YXJ0ZXJVc2Vycyhncm91cFN0YXJ0ZXJzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoU3RyaW5nVXRpbHMuaXNOb3RFbXB0eShncm91cFN0YXJ0ZXJWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cFN0YXJ0ZXJzID0gbmV3IEFycmF5TGlzdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwU3RhcnRlckFycmF5ID0gZ3JvdXBTdGFydGVyVmFsdWUuc3BsaXQoIiwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cFN0YXJ0ZXJzLmFkZEFsbChBcnJheXMuYXNMaXN0KGdyb3VwU3RhcnRlckFycmF5KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5zZXRDYW5kaWRhdGVTdGFydGVyR3JvdXBzKGdyb3VwU3RhcnRlcnMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3Muc2V0RW5hYmxlRWFnZXJFeGVjdXRpb25UcmVlRmV0Y2hpbmcoSnNvbkNvbnZlcnRlclV0aWwuZ2V0UHJvcGVydHlWYWx1ZUFzQm9vbGVhbigiaXNlYWdlcmV4ZWN1dGlvbmZldGNoIiwgbW9kZWxOb2RlLCBmYWxzZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzSnNvbkVsZW1lbnRzKHNoYXBlc0FycmF5Tm9kZSwgbW9kZWxOb2RlLCBwcm9jZXNzLCBzaGFwZU1hcCwgZm9ybUtleU1hcCwgZGVjaXNpb25UYWJsZUtleU1hcCwgYnBtbk1vZGVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEl0ZXJhdG9yIHZhcjI5ID0gc2hhcGVzQXJyYXlOb2RlLml0ZXJhdG9yKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwxOTM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSh0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSnNvbk5vZGUgc2hhcGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YXIyOS5oYXNOZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGxhYmVsMTkzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFwZU5vZGUgPSAoSnNvbk5vZGUpdmFyMjkubmV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUoISJTZXF1ZW5jZUZsb3ciLmVxdWFsc0lnbm9yZUNhc2UoQnBtbkpzb25Db252ZXJ0ZXJVdGlsLmdldFN0ZW5jaWxJZChzaGFwZU5vZGUpKSAmJiAhIkFzc29jaWF0aW9uIi5lcXVhbHNJZ25vcmVDYXNlKEJwbW5Kc29uQ29udmVydGVyVXRpbC5nZXRTdGVuY2lsSWQoc2hhcGVOb2RlKSkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmcgc291cmNlUmVmID0gQnBtbkpzb25Db252ZXJ0ZXJVdGlsLmxvb2tGb3JTb3VyY2VSZWYoc2hhcGVOb2RlLmdldCgicmVzb3VyY2VJZCIpLmFzVGV4dCgpLCBtb2RlbE5vZGUuZ2V0KCJjaGlsZFNoYXBlcyIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc291cmNlUmVmICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTGFuZSBsYW5lID0gKExhbmUpZWxlbWVudEluTGFuZU1hcC5nZXQoc291cmNlUmVmKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2VxdWVuY2VGbG93SnNvbkNvbnZlcnRlciBmbG93Q29udmVydGVyID0gbmV3IFNlcXVlbmNlRmxvd0pzb25Db252ZXJ0ZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxhbmUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvd0NvbnZlcnRlci5jb252ZXJ0VG9CcG1uTW9kZWwoc2hhcGVOb2RlLCBtb2RlbE5vZGUsIHRoaXMsIGxhbmUsIHNoYXBlTWFwLCBicG1uTW9kZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvd0NvbnZlcnRlci5jb252ZXJ0VG9CcG1uTW9kZWwoc2hhcGVOb2RlLCBtb2RlbE5vZGUsIHRoaXMsIChCYXNlRWxlbWVudClicG1uTW9kZWwuZ2V0UHJvY2Vzc2VzKCkuZ2V0KDApLCBzaGFwZU1hcCwgYnBtbk1vZGVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgTWFwPFN0cmluZywgU3ViUHJvY2Vzcz4gc3ViU2hhcGVzTWFwID0gbmV3IEhhc2hNYXAoKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2lnbmFsRGVmaW5pdGlvbkl0ZXJhdG9yID0gYnBtbk1vZGVsLmdldFByb2Nlc3NlcygpLml0ZXJhdG9yKCk7CgogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSh0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBQcm9jZXNzIHByb2Nlc3M7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSXRlcmF0b3IgdmFyNDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzaWduYWxEZWZpbml0aW9uSXRlcmF0b3IuaGFzTmV4dCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1hcDxTdHJpbmcsIEJwbW5Kc29uQ29udmVydGVyLkZsb3dXaXRoQ29udGFpbmVyPiBhbGxGbG93TWFwID0gbmV3IEhhc2hNYXAoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTGlzdDxHYXRld2F5PiBnYXRld2F5V2l0aE9yZGVyTGlzdCA9IG5ldyBBcnJheUxpc3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyNDAgPSBicG1uTW9kZWwuZ2V0UHJvY2Vzc2VzKCkuaXRlcmF0b3IoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKHZhcjQwLmhhc05leHQoKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUHJvY2VzcyBwcm9jZXNzID0gKFByb2Nlc3MpdmFyNDAubmV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3N0UHJvY2Vzc0VsZW1lbnRzKHByb2Nlc3MsIHByb2Nlc3MuZ2V0Rmxvd0VsZW1lbnRzKCksIGVkZ2VNYXAsIGJwbW5Nb2RlbCwgYWxsRmxvd01hcCwgZ2F0ZXdheVdpdGhPcmRlckxpc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBHYXRld2F5IGdhdGV3YXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXI0MCA9IGdhdGV3YXlXaXRoT3JkZXJMaXN0Lml0ZXJhdG9yKCk7IHZhcjQwLmhhc05leHQoKTsgZ2F0ZXdheS5nZXRFeHRlbnNpb25FbGVtZW50cygpLnJlbW92ZSgiRURJVE9SX0ZMT1dfT1JERVIiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2F0ZXdheSA9IChHYXRld2F5KXZhcjQwLm5leHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExpc3Q8RXh0ZW5zaW9uRWxlbWVudD4gb3JkZXJMaXN0ID0gKExpc3QpZ2F0ZXdheS5nZXRFeHRlbnNpb25FbGVtZW50cygpLmdldCgiRURJVE9SX0ZMT1dfT1JERVIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChDb2xsZWN0aW9uVXRpbHMuaXNOb3RFbXB0eShvcmRlckxpc3QpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSXRlcmF0b3IgdmFyNjQgPSBvcmRlckxpc3QuaXRlcmF0b3IoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUodmFyNjQuaGFzTmV4dCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEV4dGVuc2lvbkVsZW1lbnQgb3JkZXJFbGVtZW50ID0gKEV4dGVuc2lvbkVsZW1lbnQpdmFyNjQubmV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmcgZmxvd1ZhbHVlID0gb3JkZXJFbGVtZW50LmdldEVsZW1lbnRUZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChTdHJpbmdVdGlscy5pc05vdEVtcHR5KGZsb3dWYWx1ZSkgJiYgYWxsRmxvd01hcC5jb250YWluc0tleShmbG93VmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBCcG1uSnNvbkNvbnZlcnRlci5GbG93V2l0aENvbnRhaW5lciBmbG93V2l0aENvbnRhaW5lciA9IChCcG1uSnNvbkNvbnZlcnRlci5GbG93V2l0aENvbnRhaW5lcilhbGxGbG93TWFwLmdldChmbG93VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvd1dpdGhDb250YWluZXIuZ2V0Rmxvd0NvbnRhaW5lcigpLnJlbW92ZUZsb3dFbGVtZW50KGZsb3dXaXRoQ29udGFpbmVyLmdldFNlcXVlbmNlRmxvdygpLmdldElkKCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvd1dpdGhDb250YWluZXIuZ2V0Rmxvd0NvbnRhaW5lcigpLmFkZEZsb3dFbGVtZW50KGZsb3dXaXRoQ29udGFpbmVyLmdldFNlcXVlbmNlRmxvdygpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGJwbW5Nb2RlbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MgPSAoUHJvY2VzcylzaWduYWxEZWZpbml0aW9uSXRlcmF0b3IubmV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhcjQwID0gcHJvY2Vzcy5maW5kRmxvd0VsZW1lbnRzT2ZUeXBlKFN1YlByb2Nlc3MuY2xhc3MpLml0ZXJhdG9yKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKHZhcjQwLmhhc05leHQoKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGbG93RWxlbWVudCBmbG93RWxlbWVudCA9IChGbG93RWxlbWVudCl2YXI0MC5uZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFN1YlByb2Nlc3Mgc3ViUHJvY2VzcyA9IChTdWJQcm9jZXNzKWZsb3dFbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZpbGxTdWJTaGFwZXMoc3ViU2hhcGVzTWFwLCBzdWJQcm9jZXNzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlKHN1YlNoYXBlc01hcC5zaXplKCkgPD0gMCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgTGlzdDxTdHJpbmc+IHJlbW92ZVN1YkZsb3dzTGlzdCA9IG5ldyBBcnJheUxpc3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEl0ZXJhdG9yIHZhcjUxID0gcHJvY2Vzcy5maW5kRmxvd0VsZW1lbnRzT2ZUeXBlKFNlcXVlbmNlRmxvdy5jbGFzcykuaXRlcmF0b3IoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSh2YXI1MS5oYXNOZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGbG93RWxlbWVudCBmbG93RWxlbWVudCA9IChGbG93RWxlbWVudCl2YXI1MS5uZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2VxdWVuY2VGbG93IHNlcXVlbmNlRmxvdyA9IChTZXF1ZW5jZUZsb3cpZmxvd0VsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN1YlNoYXBlc01hcC5jb250YWluc0tleShzZXF1ZW5jZUZsb3cuZ2V0U291cmNlUmVmKCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFN1YlByb2Nlc3Mgc3ViUHJvY2VzcyA9IChTdWJQcm9jZXNzKXN1YlNoYXBlc01hcC5nZXQoc2VxdWVuY2VGbG93LmdldFNvdXJjZVJlZigpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN1YlByb2Nlc3MuZ2V0Rmxvd0VsZW1lbnQoc2VxdWVuY2VGbG93LmdldElkKCkpID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YlByb2Nlc3MuYWRkRmxvd0VsZW1lbnQoc2VxdWVuY2VGbG93KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZVN1YkZsb3dzTGlzdC5hZGQoc2VxdWVuY2VGbG93LmdldElkKCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExpc3Q8U3ViUHJvY2Vzcz4gY29sbGFwc2VkU3ViUHJvY2VzcyA9IG5ldyBBcnJheUxpc3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEl0ZXJhdG9yIHZhcjUyID0gc3ViU2hhcGVzTWFwLnZhbHVlcygpLml0ZXJhdG9yKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUodmFyNTIuaGFzTmV4dCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU3ViUHJvY2VzcyBzdWJQcm9jZXNzID0gKFN1YlByb2Nlc3MpdmFyNTIubmV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEdyYXBoaWNJbmZvIGdyYXBoaWNJbmZvID0gYnBtbk1vZGVsLmdldEdyYXBoaWNJbmZvKHN1YlByb2Nlc3MuZ2V0SWQoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdyYXBoaWNJbmZvICE9IG51bGwgJiYgQm9vbGVhbi5GQUxTRS5lcXVhbHMoZ3JhcGhpY0luZm8uZ2V0RXhwYW5kZWQoKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGFwc2VkU3ViUHJvY2Vzcy5hZGQoc3ViUHJvY2Vzcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhcjUyID0gcmVtb3ZlU3ViRmxvd3NMaXN0Lml0ZXJhdG9yKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUodmFyNTIuaGFzTmV4dCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvd0lkID0gKFN0cmluZyl2YXI1Mi5uZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5yZW1vdmVGbG93RWxlbWVudChmbG93SWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhcjIwID0gY29sbGFwc2VkU3ViUHJvY2Vzcy5pdGVyYXRvcigpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSh2YXIyMC5oYXNOZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU3ViUHJvY2VzcyBzdWJQcm9jZXNzID0gKFN1YlByb2Nlc3MpdmFyMjAubmV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJQcm9jZXNzLnJlbW92ZUZsb3dFbGVtZW50KGZsb3dJZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBzaGFwZU5vZGUgPSAoSnNvbk5vZGUpdmFyMTIubmV4dCgpOwogICAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZSA9IEJwbW5Kc29uQ29udmVydGVyVXRpbC5nZXRTdGVuY2lsSWQoc2hhcGVOb2RlKTsKICAgICAgICAgICAgICAgIH0gd2hpbGUoISJQb29sIi5lcXVhbHMobmFtZXNwYWNlKSk7CgogICAgICAgICAgICAgICAgUG9vbCBwb29sID0gbmV3IFBvb2woKTsKICAgICAgICAgICAgICAgIHBvb2wuc2V0SWQoQnBtbkpzb25Db252ZXJ0ZXJVdGlsLmdldEVsZW1lbnRJZChzaGFwZU5vZGUpKTsKICAgICAgICAgICAgICAgIHBvb2wuc2V0TmFtZShKc29uQ29udmVydGVyVXRpbC5nZXRQcm9wZXJ0eVZhbHVlQXNTdHJpbmcoIm5hbWUiLCBzaGFwZU5vZGUpKTsKICAgICAgICAgICAgICAgIHBvb2wuc2V0UHJvY2Vzc1JlZihKc29uQ29udmVydGVyVXRpbC5nZXRQcm9wZXJ0eVZhbHVlQXNTdHJpbmcoInByb2Nlc3NfaWQiLCBzaGFwZU5vZGUpKTsKICAgICAgICAgICAgICAgIHBvb2wuc2V0RXhlY3V0YWJsZShKc29uQ29udmVydGVyVXRpbC5nZXRQcm9wZXJ0eVZhbHVlQXNCb29sZWFuKCJpc2V4ZWN1dGFibGUiLCBzaGFwZU5vZGUsIHRydWUpKTsKICAgICAgICAgICAgICAgIGJwbW5Nb2RlbC5nZXRQb29scygpLmFkZChwb29sKTsKICAgICAgICAgICAgICAgIFByb2Nlc3MgcHJvY2VzcyA9IG5ldyBQcm9jZXNzKCk7CiAgICAgICAgICAgICAgICBwcm9jZXNzLnNldElkKHBvb2wuZ2V0UHJvY2Vzc1JlZigpKTsKICAgICAgICAgICAgICAgIHByb2Nlc3Muc2V0TmFtZShwb29sLmdldE5hbWUoKSk7CiAgICAgICAgICAgICAgICBwcm9jZXNzLnNldEV4ZWN1dGFibGUocG9vbC5pc0V4ZWN1dGFibGUoKSk7CiAgICAgICAgICAgICAgICBwcm9jZXNzLnNldEVuYWJsZUVhZ2VyRXhlY3V0aW9uVHJlZUZldGNoaW5nKEpzb25Db252ZXJ0ZXJVdGlsLmdldFByb3BlcnR5VmFsdWVBc0Jvb2xlYW4oImlzZWFnZXJleGVjdXRpb25mZXRjaCIsIHNoYXBlTm9kZSwgZmFsc2UpKTsKICAgICAgICAgICAgICAgIEJwbW5Kc29uQ29udmVydGVyVXRpbC5jb252ZXJ0SnNvblRvTWVzc2FnZXMobW9kZWxOb2RlLCBicG1uTW9kZWwpOwogICAgICAgICAgICAgICAgQnBtbkpzb25Db252ZXJ0ZXJVdGlsLmNvbnZlcnRKc29uVG9MaXN0ZW5lcnMobW9kZWxOb2RlLCBwcm9jZXNzKTsKICAgICAgICAgICAgICAgIGV2ZW50TGlzdGVuZXJzTm9kZSA9IEJwbW5Kc29uQ29udmVydGVyVXRpbC5nZXRQcm9wZXJ0eSgiZXZlbnRsaXN0ZW5lcnMiLCBtb2RlbE5vZGUpOwogICAgICAgICAgICAgICAgaWYgKGV2ZW50TGlzdGVuZXJzTm9kZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnRMaXN0ZW5lcnNOb2RlID0gQnBtbkpzb25Db252ZXJ0ZXJVdGlsLnZhbGlkYXRlSWZOb2RlSXNUZXh0dWFsKGV2ZW50TGlzdGVuZXJzTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgQnBtbkpzb25Db252ZXJ0ZXJVdGlsLnBhcnNlRXZlbnRMaXN0ZW5lcnMoZXZlbnRMaXN0ZW5lcnNOb2RlLmdldCgiZXZlbnRMaXN0ZW5lcnMiKSwgcHJvY2Vzcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcHJvY2Vzc0RhdGFQcm9wZXJ0aWVzTm9kZSA9IG1vZGVsTm9kZS5nZXQoInByb3BlcnRpZXMiKS5nZXQoImRhdGFwcm9wZXJ0aWVzIik7CiAgICAgICAgICAgICAgICBpZiAocHJvY2Vzc0RhdGFQcm9wZXJ0aWVzTm9kZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YU9iamVjdHMgPSBCcG1uSnNvbkNvbnZlcnRlclV0aWwuY29udmVydEpzb25Ub0RhdGFQcm9wZXJ0aWVzKHByb2Nlc3NEYXRhUHJvcGVydGllc05vZGUsIHByb2Nlc3MpOwogICAgICAgICAgICAgICAgICAgIHByb2Nlc3Muc2V0RGF0YU9iamVjdHMoZGF0YU9iamVjdHMpOwogICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZ2V0Rmxvd0VsZW1lbnRzKCkuYWRkQWxsKGRhdGFPYmplY3RzKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBicG1uTW9kZWwuYWRkUHJvY2Vzcyhwcm9jZXNzKTsKICAgICAgICAgICAgICAgIEFycmF5Tm9kZSBsYW5lQXJyYXlOb2RlID0gKEFycmF5Tm9kZSlzaGFwZU5vZGUuZ2V0KCJjaGlsZFNoYXBlcyIpOwogICAgICAgICAgICAgICAgdmFyMjAgPSBsYW5lQXJyYXlOb2RlLml0ZXJhdG9yKCk7CgogICAgICAgICAgICAgICAgd2hpbGUodHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIExhbmUgbGFuZTsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgIEpzb25Ob2RlIGxhbmVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmcgbGFuZVN0ZW5jaWxJZDsKICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YXIyMC5oYXNOZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZSBsYWJlbDIyOTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYW5lTm9kZSA9IChKc29uTm9kZSl2YXIyMC5uZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYW5lU3RlbmNpbElkID0gQnBtbkpzb25Db252ZXJ0ZXJVdGlsLmdldFN0ZW5jaWxJZChsYW5lTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUoISJMYW5lIi5lcXVhbHMobGFuZVN0ZW5jaWxJZCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgbm9uRW1wdHlQb29sRm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBsYW5lID0gbmV3IExhbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGFuZS5zZXRJZChCcG1uSnNvbkNvbnZlcnRlclV0aWwuZ2V0RWxlbWVudElkKGxhbmVOb2RlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhbmUuc2V0TmFtZShKc29uQ29udmVydGVyVXRpbC5nZXRQcm9wZXJ0eVZhbHVlQXNTdHJpbmcoIm5hbWUiLCBsYW5lTm9kZSkpOwogICAgICAgICAgICAgICAgICAgICAgICBsYW5lLnNldFBhcmVudFByb2Nlc3MocHJvY2Vzcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZ2V0TGFuZXMoKS5hZGQobGFuZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc0pzb25FbGVtZW50cyhsYW5lTm9kZS5nZXQoImNoaWxkU2hhcGVzIiksIG1vZGVsTm9kZSwgbGFuZSwgc2hhcGVNYXAsIGZvcm1LZXlNYXAsIGRlY2lzaW9uVGFibGVLZXlNYXAsIGJwbW5Nb2RlbCk7CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSghQ29sbGVjdGlvblV0aWxzLmlzTm90RW1wdHkobGFuZS5nZXRGbG93UmVmZXJlbmNlcygpKSk7CgogICAgICAgICAgICAgICAgICAgIEl0ZXJhdG9yIHZhcjI0ID0gbGFuZS5nZXRGbG93UmVmZXJlbmNlcygpLml0ZXJhdG9yKCk7CgogICAgICAgICAgICAgICAgICAgIHdoaWxlKHZhcjI0Lmhhc05leHQoKSkgewogICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmcgZWxlbWVudFJlZiA9IChTdHJpbmcpdmFyMjQubmV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50SW5MYW5lTWFwLnB1dChlbGVtZW50UmVmLCBsYW5lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gYnBtbk1vZGVsOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgdm9pZCBwcm9jZXNzSnNvbkVsZW1lbnRzKEpzb25Ob2RlIHNoYXBlc0FycmF5Tm9kZSwgSnNvbk5vZGUgbW9kZWxOb2RlLCBCYXNlRWxlbWVudCBwYXJlbnRFbGVtZW50LCBNYXA8U3RyaW5nLCBKc29uTm9kZT4gc2hhcGVNYXAsIE1hcDxTdHJpbmcsIFN0cmluZz4gZm9ybU1hcCwgTWFwPFN0cmluZywgU3RyaW5nPiBkZWNpc2lvblRhYmxlTWFwLCBCcG1uTW9kZWwgYnBtbk1vZGVsKSB7CiAgICAgICAgSXRlcmF0b3IgdmFyOCA9IHNoYXBlc0FycmF5Tm9kZS5pdGVyYXRvcigpOwoKICAgICAgICB3aGlsZSh2YXI4Lmhhc05leHQoKSkgewogICAgICAgICAgICBKc29uTm9kZSBzaGFwZU5vZGUgPSAoSnNvbk5vZGUpdmFyOC5uZXh0KCk7CiAgICAgICAgICAgIFN0cmluZyBzdGVuY2lsSWQgPSBCcG1uSnNvbkNvbnZlcnRlclV0aWwuZ2V0U3RlbmNpbElkKHNoYXBlTm9kZSk7CiAgICAgICAgICAgIENsYXNzIGNvbnZlcnRlciA9IChDbGFzcyljb252ZXJ0ZXJzVG9CcG1uTWFwLmdldChzdGVuY2lsSWQpOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIEJhc2VCcG1uSnNvbkNvbnZlcnRlciBjb252ZXJ0ZXJJbnN0YW5jZSA9IChCYXNlQnBtbkpzb25Db252ZXJ0ZXIpY29udmVydGVyLm5ld0luc3RhbmNlKCk7CiAgICAgICAgICAgICAgICBpZiAoY29udmVydGVySW5zdGFuY2UgaW5zdGFuY2VvZiBEZWNpc2lvblRhYmxlQXdhcmVDb252ZXJ0ZXIpIHsKICAgICAgICAgICAgICAgICAgICAoKERlY2lzaW9uVGFibGVBd2FyZUNvbnZlcnRlciljb252ZXJ0ZXJJbnN0YW5jZSkuc2V0RGVjaXNpb25UYWJsZU1hcChkZWNpc2lvblRhYmxlTWFwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoY29udmVydGVySW5zdGFuY2UgaW5zdGFuY2VvZiBGb3JtQXdhcmVDb252ZXJ0ZXIpIHsKICAgICAgICAgICAgICAgICAgICAoKEZvcm1Bd2FyZUNvbnZlcnRlciljb252ZXJ0ZXJJbnN0YW5jZSkuc2V0Rm9ybU1hcChmb3JtTWFwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb252ZXJ0ZXJJbnN0YW5jZS5jb252ZXJ0VG9CcG1uTW9kZWwoc2hhcGVOb2RlLCBtb2RlbE5vZGUsIHRoaXMsIHBhcmVudEVsZW1lbnQsIHNoYXBlTWFwLCBicG1uTW9kZWwpOwogICAgICAgICAgICB9IGNhdGNoIChFeGNlcHRpb24gdmFyMTMpIHsKICAgICAgICAgICAgICAgIExPR0dFUi5lcnJvcigiRXJyb3IgY29udmVydGluZyB7fSIsIEJwbW5Kc29uQ29udmVydGVyVXRpbC5nZXRTdGVuY2lsSWQoc2hhcGVOb2RlKSwgdmFyMTMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0KCiAgICBwcml2YXRlIHZvaWQgZmlsbFN1YlNoYXBlcyhNYXA8U3RyaW5nLCBTdWJQcm9jZXNzPiBzdWJTaGFwZXNNYXAsIFN1YlByb2Nlc3Mgc3ViUHJvY2VzcykgewogICAgICAgIEl0ZXJhdG9yIHZhcjMgPSBzdWJQcm9jZXNzLmdldEZsb3dFbGVtZW50cygpLml0ZXJhdG9yKCk7CgogICAgICAgIHdoaWxlKHZhcjMuaGFzTmV4dCgpKSB7CiAgICAgICAgICAgIEZsb3dFbGVtZW50IGZsb3dFbGVtZW50ID0gKEZsb3dFbGVtZW50KXZhcjMubmV4dCgpOwogICAgICAgICAgICBpZiAoZmxvd0VsZW1lbnQgaW5zdGFuY2VvZiBTdWJQcm9jZXNzKSB7CiAgICAgICAgICAgICAgICBTdWJQcm9jZXNzIGNoaWxkU3ViUHJvY2VzcyA9IChTdWJQcm9jZXNzKWZsb3dFbGVtZW50OwogICAgICAgICAgICAgICAgc3ViU2hhcGVzTWFwLnB1dChjaGlsZFN1YlByb2Nlc3MuZ2V0SWQoKSwgc3ViUHJvY2Vzcyk7CiAgICAgICAgICAgICAgICB0aGlzLmZpbGxTdWJTaGFwZXMoc3ViU2hhcGVzTWFwLCBjaGlsZFN1YlByb2Nlc3MpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3ViU2hhcGVzTWFwLnB1dChmbG93RWxlbWVudC5nZXRJZCgpLCBzdWJQcm9jZXNzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9CgogICAgcHJpdmF0ZSB2b2lkIHBvc3RQcm9jZXNzRWxlbWVudHMoRmxvd0VsZW1lbnRzQ29udGFpbmVyIHBhcmVudENvbnRhaW5lciwgQ29sbGVjdGlvbjxGbG93RWxlbWVudD4gZmxvd0VsZW1lbnRMaXN0LCBNYXA8U3RyaW5nLCBKc29uTm9kZT4gZWRnZU1hcCwgQnBtbk1vZGVsIGJwbW5Nb2RlbCwgTWFwPFN0cmluZywgQnBtbkpzb25Db252ZXJ0ZXIuRmxvd1dpdGhDb250YWluZXI+IGFsbEZsb3dNYXAsIExpc3Q8R2F0ZXdheT4gZ2F0ZXdheVdpdGhPcmRlckxpc3QpIHsKICAgICAgICBJdGVyYXRvciB2YXI3ID0gZmxvd0VsZW1lbnRMaXN0Lml0ZXJhdG9yKCk7CgogICAgICAgIHdoaWxlKHZhcjcuaGFzTmV4dCgpKSB7CiAgICAgICAgICAgIEZsb3dFbGVtZW50IGZsb3dFbGVtZW50ID0gKEZsb3dFbGVtZW50KXZhcjcubmV4dCgpOwogICAgICAgICAgICBwYXJlbnRDb250YWluZXIuYWRkRmxvd0VsZW1lbnRUb01hcChmbG93RWxlbWVudCk7CiAgICAgICAgICAgIGlmIChmbG93RWxlbWVudCBpbnN0YW5jZW9mIEV2ZW50KSB7CiAgICAgICAgICAgICAgICBFdmVudCBldmVudCA9IChFdmVudClmbG93RWxlbWVudDsKICAgICAgICAgICAgICAgIGlmIChDb2xsZWN0aW9uVXRpbHMuaXNOb3RFbXB0eShldmVudC5nZXRFdmVudERlZmluaXRpb25zKCkpKSB7CiAgICAgICAgICAgICAgICAgICAgRXZlbnREZWZpbml0aW9uIGV2ZW50RGVmID0gKEV2ZW50RGVmaW5pdGlvbilldmVudC5nZXRFdmVudERlZmluaXRpb25zKCkuZ2V0KDApOwogICAgICAgICAgICAgICAgICAgIGlmIChldmVudERlZiBpbnN0YW5jZW9mIFNpZ25hbEV2ZW50RGVmaW5pdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBTaWduYWxFdmVudERlZmluaXRpb24gc2lnbmFsRXZlbnREZWYgPSAoU2lnbmFsRXZlbnREZWZpbml0aW9uKWV2ZW50RGVmOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoU3RyaW5nVXRpbHMuaXNOb3RFbXB0eShzaWduYWxFdmVudERlZi5nZXRTaWduYWxSZWYoKSkgJiYgYnBtbk1vZGVsLmdldFNpZ25hbChzaWduYWxFdmVudERlZi5nZXRTaWduYWxSZWYoKSkgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnBtbk1vZGVsLmFkZFNpZ25hbChuZXcgU2lnbmFsKHNpZ25hbEV2ZW50RGVmLmdldFNpZ25hbFJlZigpLCBzaWduYWxFdmVudERlZi5nZXRTaWduYWxSZWYoKSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChldmVudERlZiBpbnN0YW5jZW9mIE1lc3NhZ2VFdmVudERlZmluaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgTWVzc2FnZUV2ZW50RGVmaW5pdGlvbiBtZXNzYWdlRXZlbnREZWYgPSAoTWVzc2FnZUV2ZW50RGVmaW5pdGlvbilldmVudERlZjsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFN0cmluZ1V0aWxzLmlzTm90RW1wdHkobWVzc2FnZUV2ZW50RGVmLmdldE1lc3NhZ2VSZWYoKSkgJiYgYnBtbk1vZGVsLmdldE1lc3NhZ2UobWVzc2FnZUV2ZW50RGVmLmdldE1lc3NhZ2VSZWYoKSkgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnBtbk1vZGVsLmFkZE1lc3NhZ2UobmV3IE1lc3NhZ2UobWVzc2FnZUV2ZW50RGVmLmdldE1lc3NhZ2VSZWYoKSwgbWVzc2FnZUV2ZW50RGVmLmdldE1lc3NhZ2VSZWYoKSwgKFN0cmluZyludWxsKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmbG93RWxlbWVudCBpbnN0YW5jZW9mIEJvdW5kYXJ5RXZlbnQpIHsKICAgICAgICAgICAgICAgIEJvdW5kYXJ5RXZlbnQgYm91bmRhcnlFdmVudCA9IChCb3VuZGFyeUV2ZW50KWZsb3dFbGVtZW50OwogICAgICAgICAgICAgICAgQWN0aXZpdHkgYWN0aXZpdHkgPSB0aGlzLnJldHJpZXZlQXR0YWNoZWRSZWZPYmplY3QoYm91bmRhcnlFdmVudC5nZXRBdHRhY2hlZFRvUmVmSWQoKSwgcGFyZW50Q29udGFpbmVyLmdldEZsb3dFbGVtZW50cygpKTsKICAgICAgICAgICAgICAgIGlmIChhY3Rpdml0eSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgTE9HR0VSLndhcm4oIkJvdW5kYXJ5IGV2ZW50IHt9IGlzIG5vdCBhdHRhY2hlZCB0byBhbnkgYWN0aXZpdHkiLCBib3VuZGFyeUV2ZW50LmdldElkKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBib3VuZGFyeUV2ZW50LnNldEF0dGFjaGVkVG9SZWYoYWN0aXZpdHkpOwogICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5LmdldEJvdW5kYXJ5RXZlbnRzKCkuYWRkKGJvdW5kYXJ5RXZlbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGZsb3dFbGVtZW50IGluc3RhbmNlb2YgR2F0ZXdheSkgewogICAgICAgICAgICAgICAgaWYgKGZsb3dFbGVtZW50LmdldEV4dGVuc2lvbkVsZW1lbnRzKCkuY29udGFpbnNLZXkoIkVESVRPUl9GTE9XX09SREVSIikpIHsKICAgICAgICAgICAgICAgICAgICBnYXRld2F5V2l0aE9yZGVyTGlzdC5hZGQoKEdhdGV3YXkpZmxvd0VsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGZsb3dFbGVtZW50IGluc3RhbmNlb2YgU3ViUHJvY2VzcykgewogICAgICAgICAgICAgICAgU3ViUHJvY2VzcyBzdWJQcm9jZXNzID0gKFN1YlByb2Nlc3MpZmxvd0VsZW1lbnQ7CiAgICAgICAgICAgICAgICB0aGlzLnBvc3RQcm9jZXNzRWxlbWVudHMoc3ViUHJvY2Vzcywgc3ViUHJvY2Vzcy5nZXRGbG93RWxlbWVudHMoKSwgZWRnZU1hcCwgYnBtbk1vZGVsLCBhbGxGbG93TWFwLCBnYXRld2F5V2l0aE9yZGVyTGlzdCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmxvd0VsZW1lbnQgaW5zdGFuY2VvZiBTZXF1ZW5jZUZsb3cpIHsKICAgICAgICAgICAgICAgIFNlcXVlbmNlRmxvdyBzZXF1ZW5jZUZsb3cgPSAoU2VxdWVuY2VGbG93KWZsb3dFbGVtZW50OwogICAgICAgICAgICAgICAgRmxvd0VsZW1lbnQgc291cmNlRmxvd0VsZW1lbnQgPSBwYXJlbnRDb250YWluZXIuZ2V0Rmxvd0VsZW1lbnQoc2VxdWVuY2VGbG93LmdldFNvdXJjZVJlZigpKTsKICAgICAgICAgICAgICAgIGlmIChzb3VyY2VGbG93RWxlbWVudCBpbnN0YW5jZW9mIEZsb3dOb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgQnBtbkpzb25Db252ZXJ0ZXIuRmxvd1dpdGhDb250YWluZXIgZmxvd1dpdGhDb250YWluZXIgPSBuZXcgQnBtbkpzb25Db252ZXJ0ZXIuRmxvd1dpdGhDb250YWluZXIoc2VxdWVuY2VGbG93LCBwYXJlbnRDb250YWluZXIpOwogICAgICAgICAgICAgICAgICAgIGlmIChzZXF1ZW5jZUZsb3cuZ2V0RXh0ZW5zaW9uRWxlbWVudHMoKS5nZXQoIkVESVRPUl9SRVNPVVJDRUlEIikgIT0gbnVsbCAmJiAoKExpc3Qpc2VxdWVuY2VGbG93LmdldEV4dGVuc2lvbkVsZW1lbnRzKCkuZ2V0KCJFRElUT1JfUkVTT1VSQ0VJRCIpKS5zaXplKCkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFsbEZsb3dNYXAucHV0KCgoRXh0ZW5zaW9uRWxlbWVudCkoKExpc3Qpc2VxdWVuY2VGbG93LmdldEV4dGVuc2lvbkVsZW1lbnRzKCkuZ2V0KCJFRElUT1JfUkVTT1VSQ0VJRCIpKS5nZXQoMCkpLmdldEVsZW1lbnRUZXh0KCksIGZsb3dXaXRoQ29udGFpbmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2VxdWVuY2VGbG93LmdldEV4dGVuc2lvbkVsZW1lbnRzKCkucmVtb3ZlKCJFRElUT1JfUkVTT1VSQ0VJRCIpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgKChGbG93Tm9kZSlzb3VyY2VGbG93RWxlbWVudCkuZ2V0T3V0Z29pbmdGbG93cygpLmFkZChzZXF1ZW5jZUZsb3cpOwogICAgICAgICAgICAgICAgICAgIEpzb25Ob2RlIGVkZ2VOb2RlID0gKEpzb25Ob2RlKWVkZ2VNYXAuZ2V0KHNlcXVlbmNlRmxvdy5nZXRJZCgpKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZWRnZU5vZGUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBib29sZWFuIGlzRGVmYXVsdCA9IEpzb25Db252ZXJ0ZXJVdGlsLmdldFByb3BlcnR5VmFsdWVBc0Jvb2xlYW4oImRlZmF1bHRmbG93IiwgZWRnZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNEZWZhdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc291cmNlRmxvd0VsZW1lbnQgaW5zdGFuY2VvZiBBY3Rpdml0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgoQWN0aXZpdHkpc291cmNlRmxvd0VsZW1lbnQpLnNldERlZmF1bHRGbG93KHNlcXVlbmNlRmxvdy5nZXRJZCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc291cmNlRmxvd0VsZW1lbnQgaW5zdGFuY2VvZiBHYXRld2F5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKChHYXRld2F5KXNvdXJjZUZsb3dFbGVtZW50KS5zZXREZWZhdWx0RmxvdyhzZXF1ZW5jZUZsb3cuZ2V0SWQoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgRmxvd0VsZW1lbnQgdGFyZ2V0Rmxvd0VsZW1lbnQgPSBwYXJlbnRDb250YWluZXIuZ2V0Rmxvd0VsZW1lbnQoc2VxdWVuY2VGbG93LmdldFRhcmdldFJlZigpKTsKICAgICAgICAgICAgICAgIGlmICh0YXJnZXRGbG93RWxlbWVudCBpbnN0YW5jZW9mIEZsb3dOb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgKChGbG93Tm9kZSl0YXJnZXRGbG93RWxlbWVudCkuZ2V0SW5jb21pbmdGbG93cygpLmFkZChzZXF1ZW5jZUZsb3cpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0KCiAgICBwcml2YXRlIEFjdGl2aXR5IHJldHJpZXZlQXR0YWNoZWRSZWZPYmplY3QoU3RyaW5nIGF0dGFjaGVkVG9SZWZJZCwgQ29sbGVjdGlvbjxGbG93RWxlbWVudD4gZmxvd0VsZW1lbnRMaXN0KSB7CiAgICAgICAgQWN0aXZpdHkgYWN0aXZpdHkgPSBudWxsOwogICAgICAgIGlmIChTdHJpbmdVdGlscy5pc05vdEVtcHR5KGF0dGFjaGVkVG9SZWZJZCkpIHsKICAgICAgICAgICAgSXRlcmF0b3IgdmFyNCA9IGZsb3dFbGVtZW50TGlzdC5pdGVyYXRvcigpOwoKICAgICAgICAgICAgd2hpbGUodmFyNC5oYXNOZXh0KCkpIHsKICAgICAgICAgICAgICAgIEZsb3dFbGVtZW50IGZsb3dFbGVtZW50ID0gKEZsb3dFbGVtZW50KXZhcjQubmV4dCgpOwogICAgICAgICAgICAgICAgaWYgKGF0dGFjaGVkVG9SZWZJZC5lcXVhbHMoZmxvd0VsZW1lbnQuZ2V0SWQoKSkpIHsKICAgICAgICAgICAgICAgICAgICBhY3Rpdml0eSA9IChBY3Rpdml0eSlmbG93RWxlbWVudDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZmxvd0VsZW1lbnQgaW5zdGFuY2VvZiBTdWJQcm9jZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgU3ViUHJvY2VzcyBzdWJQcm9jZXNzID0gKFN1YlByb2Nlc3MpZmxvd0VsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgQWN0aXZpdHkgcmV0cmlldmVkQWN0aXZpdHkgPSB0aGlzLnJldHJpZXZlQXR0YWNoZWRSZWZPYmplY3QoYXR0YWNoZWRUb1JlZklkLCBzdWJQcm9jZXNzLmdldEZsb3dFbGVtZW50cygpKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmV0cmlldmVkQWN0aXZpdHkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpdml0eSA9IHJldHJpZXZlZEFjdGl2aXR5OwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBhY3Rpdml0eTsKICAgIH0KCiAgICBwcml2YXRlIHZvaWQgcmVhZFNoYXBlREkoSnNvbk5vZGUgb2JqZWN0Tm9kZSwgZG91YmxlIHBhcmVudFgsIGRvdWJsZSBwYXJlbnRZLCBNYXA8U3RyaW5nLCBKc29uTm9kZT4gc2hhcGVNYXAsIE1hcDxTdHJpbmcsIEpzb25Ob2RlPiBzb3VyY2VSZWZNYXAsIEJwbW5Nb2RlbCBicG1uTW9kZWwpIHsKICAgICAgICBpZiAob2JqZWN0Tm9kZS5nZXQoImNoaWxkU2hhcGVzIikgIT0gbnVsbCkgewogICAgICAgICAgICBJdGVyYXRvciB2YXI5ID0gb2JqZWN0Tm9kZS5nZXQoImNoaWxkU2hhcGVzIikuaXRlcmF0b3IoKTsKCiAgICAgICAgICAgIHdoaWxlKHRydWUpIHsKICAgICAgICAgICAgICAgIEpzb25Ob2RlIGpzb25DaGlsZE5vZGU7CiAgICAgICAgICAgICAgICBTdHJpbmcgc3RlbmNpbElkOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIGlmICghdmFyOS5oYXNOZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAganNvbkNoaWxkTm9kZSA9IChKc29uTm9kZSl2YXI5Lm5leHQoKTsKICAgICAgICAgICAgICAgICAgICBzdGVuY2lsSWQgPSBCcG1uSnNvbkNvbnZlcnRlclV0aWwuZ2V0U3RlbmNpbElkKGpzb25DaGlsZE5vZGUpOwogICAgICAgICAgICAgICAgfSB3aGlsZSgiU2VxdWVuY2VGbG93Ii5lcXVhbHMoc3RlbmNpbElkKSk7CgogICAgICAgICAgICAgICAgR3JhcGhpY0luZm8gZ3JhcGhpY0luZm8gPSBuZXcgR3JhcGhpY0luZm8oKTsKICAgICAgICAgICAgICAgIEpzb25Ob2RlIGJvdW5kc05vZGUgPSBqc29uQ2hpbGROb2RlLmdldCgiYm91bmRzIik7CiAgICAgICAgICAgICAgICBPYmplY3ROb2RlIHVwcGVyTGVmdE5vZGUgPSAoT2JqZWN0Tm9kZSlib3VuZHNOb2RlLmdldCgidXBwZXJMZWZ0Iik7CiAgICAgICAgICAgICAgICBPYmplY3ROb2RlIGxvd2VyUmlnaHROb2RlID0gKE9iamVjdE5vZGUpYm91bmRzTm9kZS5nZXQoImxvd2VyUmlnaHQiKTsKICAgICAgICAgICAgICAgIGdyYXBoaWNJbmZvLnNldFgodXBwZXJMZWZ0Tm9kZS5nZXQoIngiKS5hc0RvdWJsZSgpICsgcGFyZW50WCk7CiAgICAgICAgICAgICAgICBncmFwaGljSW5mby5zZXRZKHVwcGVyTGVmdE5vZGUuZ2V0KCJ5IikuYXNEb3VibGUoKSArIHBhcmVudFkpOwogICAgICAgICAgICAgICAgZ3JhcGhpY0luZm8uc2V0V2lkdGgobG93ZXJSaWdodE5vZGUuZ2V0KCJ4IikuYXNEb3VibGUoKSAtIGdyYXBoaWNJbmZvLmdldFgoKSArIHBhcmVudFgpOwogICAgICAgICAgICAgICAgZ3JhcGhpY0luZm8uc2V0SGVpZ2h0KGxvd2VyUmlnaHROb2RlLmdldCgieSIpLmFzRG91YmxlKCkgLSBncmFwaGljSW5mby5nZXRZKCkgKyBwYXJlbnRZKTsKICAgICAgICAgICAgICAgIFN0cmluZyBjaGlsZFNoYXBlSWQgPSBqc29uQ2hpbGROb2RlLmdldCgicmVzb3VyY2VJZCIpLmFzVGV4dCgpOwogICAgICAgICAgICAgICAgYnBtbk1vZGVsLmFkZEdyYXBoaWNJbmZvKEJwbW5Kc29uQ29udmVydGVyVXRpbC5nZXRFbGVtZW50SWQoanNvbkNoaWxkTm9kZSksIGdyYXBoaWNJbmZvKTsKICAgICAgICAgICAgICAgIHNoYXBlTWFwLnB1dChjaGlsZFNoYXBlSWQsIGpzb25DaGlsZE5vZGUpOwogICAgICAgICAgICAgICAgQXJyYXlOb2RlIG91dGdvaW5nTm9kZSA9IChBcnJheU5vZGUpanNvbkNoaWxkTm9kZS5nZXQoIm91dGdvaW5nIik7CiAgICAgICAgICAgICAgICBpZiAob3V0Z29pbmdOb2RlICE9IG51bGwgJiYgb3V0Z29pbmdOb2RlLnNpemUoKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICBJdGVyYXRvciB2YXIxOCA9IG91dGdvaW5nTm9kZS5pdGVyYXRvcigpOwoKICAgICAgICAgICAgICAgICAgICB3aGlsZSh2YXIxOC5oYXNOZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgSnNvbk5vZGUgb3V0Z29pbmdDaGlsZE5vZGUgPSAoSnNvbk5vZGUpdmFyMTgubmV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICBKc29uTm9kZSByZXNvdXJjZU5vZGUgPSBvdXRnb2luZ0NoaWxkTm9kZS5nZXQoInJlc291cmNlSWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc291cmNlTm9kZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VSZWZNYXAucHV0KHJlc291cmNlTm9kZS5hc1RleHQoKSwganNvbkNoaWxkTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCJDb2xsYXBzZWRTdWJQcm9jZXNzIi5lcXVhbHMoc3RlbmNpbElkKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVhZFNoYXBlREkoanNvbkNoaWxkTm9kZSwgMC4wRCwgMC4wRCwgc2hhcGVNYXAsIHNvdXJjZVJlZk1hcCwgYnBtbk1vZGVsKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWFkU2hhcGVESShqc29uQ2hpbGROb2RlLCBncmFwaGljSW5mby5nZXRYKCksIGdyYXBoaWNJbmZvLmdldFkoKSwgc2hhcGVNYXAsIHNvdXJjZVJlZk1hcCwgYnBtbk1vZGVsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIHZvaWQgZmlsdGVyQWxsRWRnZXMoSnNvbk5vZGUgb2JqZWN0Tm9kZSwgTWFwPFN0cmluZywgSnNvbk5vZGU+IGVkZ2VNYXAsIE1hcDxTdHJpbmcsIExpc3Q8SnNvbk5vZGU+PiBzb3VyY2VBbmRUYXJnZXRNYXAsIE1hcDxTdHJpbmcsIEpzb25Ob2RlPiBzaGFwZU1hcCwgTWFwPFN0cmluZywgSnNvbk5vZGU+IHNvdXJjZVJlZk1hcCkgewogICAgICAgIGlmIChvYmplY3ROb2RlLmdldCgiY2hpbGRTaGFwZXMiKSAhPSBudWxsKSB7CiAgICAgICAgICAgIEl0ZXJhdG9yIHZhcjYgPSBvYmplY3ROb2RlLmdldCgiY2hpbGRTaGFwZXMiKS5pdGVyYXRvcigpOwoKICAgICAgICAgICAgd2hpbGUodHJ1ZSkgewogICAgICAgICAgICAgICAgT2JqZWN0Tm9kZSBjaGlsZE5vZGU7CiAgICAgICAgICAgICAgICBTdHJpbmcgc3RlbmNpbElkOwogICAgICAgICAgICAgICAgbGFiZWw0MDoKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICB3aGlsZSh2YXI2Lmhhc05leHQoKSkgewogICAgICAgICAgICAgICAgICAgICAgICBKc29uTm9kZSBqc29uQ2hpbGROb2RlID0gKEpzb25Ob2RlKXZhcjYubmV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUgPSAoT2JqZWN0Tm9kZSlqc29uQ2hpbGROb2RlOwogICAgICAgICAgICAgICAgICAgICAgICBzdGVuY2lsSWQgPSBCcG1uSnNvbkNvbnZlcnRlclV0aWwuZ2V0U3RlbmNpbElkKGNoaWxkTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghIlN1YlByb2Nlc3MiLmVxdWFscyhzdGVuY2lsSWQpICYmICEiUG9vbCIuZXF1YWxzKHN0ZW5jaWxJZCkgJiYgISJMYW5lIi5lcXVhbHMoc3RlbmNpbElkKSAmJiAhIkNvbGxhcHNlZFN1YlByb2Nlc3MiLmVxdWFscyhzdGVuY2lsSWQpICYmICEiRXZlbnRTdWJQcm9jZXNzIi5lcXVhbHMoc3RlbmNpbElkKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUgbGFiZWw0MDsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5maWx0ZXJBbGxFZGdlcyhjaGlsZE5vZGUsIGVkZ2VNYXAsIHNvdXJjZUFuZFRhcmdldE1hcCwgc2hhcGVNYXAsIHNvdXJjZVJlZk1hcCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IHdoaWxlKCEiU2VxdWVuY2VGbG93Ii5lcXVhbHMoc3RlbmNpbElkKSAmJiAhIkFzc29jaWF0aW9uIi5lcXVhbHMoc3RlbmNpbElkKSk7CgogICAgICAgICAgICAgICAgU3RyaW5nIGNoaWxkRWRnZUlkID0gQnBtbkpzb25Db252ZXJ0ZXJVdGlsLmdldEVsZW1lbnRJZChjaGlsZE5vZGUpOwogICAgICAgICAgICAgICAgSnNvbk5vZGUgdGFyZ2V0Tm9kZSA9IGNoaWxkTm9kZS5nZXQoInRhcmdldCIpOwogICAgICAgICAgICAgICAgaWYgKHRhcmdldE5vZGUgIT0gbnVsbCAmJiAhdGFyZ2V0Tm9kZS5pc051bGwoKSkgewogICAgICAgICAgICAgICAgICAgIFN0cmluZyB0YXJnZXRSZWZJZCA9IHRhcmdldE5vZGUuZ2V0KCJyZXNvdXJjZUlkIikuYXNUZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgTGlzdDxKc29uTm9kZT4gc291cmNlQW5kVGFyZ2V0TGlzdCA9IG5ldyBBcnJheUxpc3QoKTsKICAgICAgICAgICAgICAgICAgICBzb3VyY2VBbmRUYXJnZXRMaXN0LmFkZChzb3VyY2VSZWZNYXAuZ2V0KGNoaWxkTm9kZS5nZXQoInJlc291cmNlSWQiKS5hc1RleHQoKSkpOwogICAgICAgICAgICAgICAgICAgIHNvdXJjZUFuZFRhcmdldExpc3QuYWRkKHNoYXBlTWFwLmdldCh0YXJnZXRSZWZJZCkpOwogICAgICAgICAgICAgICAgICAgIHNvdXJjZUFuZFRhcmdldE1hcC5wdXQoY2hpbGRFZGdlSWQsIHNvdXJjZUFuZFRhcmdldExpc3QpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGVkZ2VNYXAucHV0KGNoaWxkRWRnZUlkLCBjaGlsZE5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHByaXZhdGUgdm9pZCByZWFkRWRnZURJKE1hcDxTdHJpbmcsIEpzb25Ob2RlPiBlZGdlTWFwLCBNYXA8U3RyaW5nLCBMaXN0PEpzb25Ob2RlPj4gc291cmNlQW5kVGFyZ2V0TWFwLCBCcG1uTW9kZWwgYnBtbk1vZGVsKSB7CiAgICAgICAgSXRlcmF0b3IgdmFyNCA9IGVkZ2VNYXAua2V5U2V0KCkuaXRlcmF0b3IoKTsKCiAgICAgICAgd2hpbGUodHJ1ZSkgewogICAgICAgICAgICB3aGlsZSh2YXI0Lmhhc05leHQoKSkgewogICAgICAgICAgICAgICAgU3RyaW5nIGVkZ2VJZCA9IChTdHJpbmcpdmFyNC5uZXh0KCk7CiAgICAgICAgICAgICAgICBKc29uTm9kZSBlZGdlTm9kZSA9IChKc29uTm9kZSllZGdlTWFwLmdldChlZGdlSWQpOwogICAgICAgICAgICAgICAgTGlzdDxKc29uTm9kZT4gc291cmNlQW5kVGFyZ2V0TGlzdCA9IChMaXN0KXNvdXJjZUFuZFRhcmdldE1hcC5nZXQoZWRnZUlkKTsKICAgICAgICAgICAgICAgIEpzb25Ob2RlIHNvdXJjZVJlZk5vZGUgPSBudWxsOwogICAgICAgICAgICAgICAgSnNvbk5vZGUgdGFyZ2V0UmVmTm9kZSA9IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoc291cmNlQW5kVGFyZ2V0TGlzdCAhPSBudWxsICYmIHNvdXJjZUFuZFRhcmdldExpc3Quc2l6ZSgpID4gMSkgewogICAgICAgICAgICAgICAgICAgIHNvdXJjZVJlZk5vZGUgPSAoSnNvbk5vZGUpc291cmNlQW5kVGFyZ2V0TGlzdC5nZXQoMCk7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UmVmTm9kZSA9IChKc29uTm9kZSlzb3VyY2VBbmRUYXJnZXRMaXN0LmdldCgxKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoc291cmNlUmVmTm9kZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgTE9HR0VSLmluZm8oIlNraXBwaW5nIGVkZ2Uge30gYmVjYXVzZSBzb3VyY2UgcmVmIGlzIG51bGwiLCBlZGdlSWQpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0YXJnZXRSZWZOb2RlID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBMT0dHRVIuaW5mbygiU2tpcHBpbmcgZWRnZSB7fSBiZWNhdXNlIHRhcmdldCByZWYgaXMgbnVsbCIsIGVkZ2VJZCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIEpzb25Ob2RlIGRvY2tlcnNOb2RlID0gZWRnZU5vZGUuZ2V0KCJkb2NrZXJzIik7CiAgICAgICAgICAgICAgICAgICAgZG91YmxlIHNvdXJjZURvY2tlcnNYID0gZG9ja2Vyc05vZGUuZ2V0KDApLmdldCgieCIpLmFzRG91YmxlKCk7CiAgICAgICAgICAgICAgICAgICAgZG91YmxlIHNvdXJjZURvY2tlcnNZID0gZG9ja2Vyc05vZGUuZ2V0KDApLmdldCgieSIpLmFzRG91YmxlKCk7CiAgICAgICAgICAgICAgICAgICAgR3JhcGhpY0luZm8gc291cmNlSW5mbyA9IGJwbW5Nb2RlbC5nZXRHcmFwaGljSW5mbyhCcG1uSnNvbkNvbnZlcnRlclV0aWwuZ2V0RWxlbWVudElkKHNvdXJjZVJlZk5vZGUpKTsKICAgICAgICAgICAgICAgICAgICBHcmFwaGljSW5mbyB0YXJnZXRJbmZvID0gYnBtbk1vZGVsLmdldEdyYXBoaWNJbmZvKEJwbW5Kc29uQ29udmVydGVyVXRpbC5nZXRFbGVtZW50SWQodGFyZ2V0UmVmTm9kZSkpOwogICAgICAgICAgICAgICAgICAgIGRvdWJsZSBzb3VyY2VSZWZMaW5lWCA9IHNvdXJjZUluZm8uZ2V0WCgpICsgc291cmNlRG9ja2Vyc1g7CiAgICAgICAgICAgICAgICAgICAgZG91YmxlIHNvdXJjZVJlZkxpbmVZID0gc291cmNlSW5mby5nZXRZKCkgKyBzb3VyY2VEb2NrZXJzWTsKICAgICAgICAgICAgICAgICAgICBkb3VibGUgbmV4dFBvaW50SW5MaW5lWCA9IGRvY2tlcnNOb2RlLmdldCgxKS5nZXQoIngiKS5hc0RvdWJsZSgpOwogICAgICAgICAgICAgICAgICAgIGRvdWJsZSBuZXh0UG9pbnRJbkxpbmVZID0gZG9ja2Vyc05vZGUuZ2V0KDEpLmdldCgieSIpLmFzRG91YmxlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvY2tlcnNOb2RlLnNpemUoKSA9PSAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5leHRQb2ludEluTGluZVggKz0gdGFyZ2V0SW5mby5nZXRYKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5leHRQb2ludEluTGluZVkgKz0gdGFyZ2V0SW5mby5nZXRZKCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBMaW5lMkQgZmlyc3RMaW5lID0gbmV3IERvdWJsZShzb3VyY2VSZWZMaW5lWCwgc291cmNlUmVmTGluZVksIG5leHRQb2ludEluTGluZVgsIG5leHRQb2ludEluTGluZVkpOwogICAgICAgICAgICAgICAgICAgIFN0cmluZyBzb3VyY2VSZWZTdGVuY2lsSWQgPSBCcG1uSnNvbkNvbnZlcnRlclV0aWwuZ2V0U3RlbmNpbElkKHNvdXJjZVJlZk5vZGUpOwogICAgICAgICAgICAgICAgICAgIFN0cmluZyB0YXJnZXRSZWZTdGVuY2lsSWQgPSBCcG1uSnNvbkNvbnZlcnRlclV0aWwuZ2V0U3RlbmNpbElkKHRhcmdldFJlZk5vZGUpOwogICAgICAgICAgICAgICAgICAgIExpc3Q8R3JhcGhpY0luZm8+IGdyYXBoaWNJbmZvTGlzdCA9IG5ldyBBcnJheUxpc3QoKTsKICAgICAgICAgICAgICAgICAgICBBcmVhIHNvdXJjZTJEID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBpZiAoRElfQ0lSQ0xFUy5jb250YWlucyhzb3VyY2VSZWZTdGVuY2lsSWQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZTJEID0gdGhpcy5jcmVhdGVFbGxpcHNlKHNvdXJjZUluZm8sIHNvdXJjZURvY2tlcnNYLCBzb3VyY2VEb2NrZXJzWSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChESV9SRUNUQU5HTEVTLmNvbnRhaW5zKHNvdXJjZVJlZlN0ZW5jaWxJZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlMkQgPSB0aGlzLmNyZWF0ZVJlY3RhbmdsZShzb3VyY2VJbmZvKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKERJX0dBVEVXQVkuY29udGFpbnMoc291cmNlUmVmU3RlbmNpbElkKSkgewogICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2UyRCA9IHRoaXMuY3JlYXRlR2F0ZXdheShzb3VyY2VJbmZvKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIENvbGxlY3Rpb24gaW50ZXJzZWN0aW9uczsKICAgICAgICAgICAgICAgICAgICBpZiAoc291cmNlMkQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb25zID0gdGhpcy5nZXRJbnRlcnNlY3Rpb25zKGZpcnN0TGluZSwgc291cmNlMkQpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW50ZXJzZWN0aW9ucyAhPSBudWxsICYmIGludGVyc2VjdGlvbnMuc2l6ZSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgUG9pbnQyRCBpbnRlcnNlY3Rpb24gPSAoUG9pbnQyRClpbnRlcnNlY3Rpb25zLml0ZXJhdG9yKCkubmV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhcGhpY0luZm9MaXN0LmFkZCh0aGlzLmNyZWF0ZUdyYXBoaWNJbmZvKGludGVyc2VjdGlvbi5nZXRYKCksIGludGVyc2VjdGlvbi5nZXRZKCkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYXBoaWNJbmZvTGlzdC5hZGQodGhpcy5jcmVhdGVHcmFwaGljSW5mbyhzb3VyY2VSZWZMaW5lWCwgc291cmNlUmVmTGluZVkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9ucyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgZG91YmxlIHRhcmdldERvY2tlcnNYOwogICAgICAgICAgICAgICAgICAgIGRvdWJsZSB0YXJnZXREb2NrZXJzWTsKICAgICAgICAgICAgICAgICAgICBEb3VibGUgbGFzdExpbmU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvY2tlcnNOb2RlLnNpemUoKSA+IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGludCBpID0gMTsgaSA8IGRvY2tlcnNOb2RlLnNpemUoKSAtIDE7ICsraSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0RG9ja2Vyc1ggPSBkb2NrZXJzTm9kZS5nZXQoaSkuZ2V0KCJ4IikuYXNEb3VibGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldERvY2tlcnNZID0gZG9ja2Vyc05vZGUuZ2V0KGkpLmdldCgieSIpLmFzRG91YmxlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFwaGljSW5mb0xpc3QuYWRkKHRoaXMuY3JlYXRlR3JhcGhpY0luZm8odGFyZ2V0RG9ja2Vyc1gsIHRhcmdldERvY2tlcnNZKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGRvdWJsZSBzdGFydExhc3RMaW5lWCA9IGRvY2tlcnNOb2RlLmdldChkb2NrZXJzTm9kZS5zaXplKCkgLSAyKS5nZXQoIngiKS5hc0RvdWJsZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBkb3VibGUgc3RhcnRMYXN0TGluZVkgPSBkb2NrZXJzTm9kZS5nZXQoZG9ja2Vyc05vZGUuc2l6ZSgpIC0gMikuZ2V0KCJ5IikuYXNEb3VibGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgZG91YmxlIGVuZExhc3RMaW5lWCA9IGRvY2tlcnNOb2RlLmdldChkb2NrZXJzTm9kZS5zaXplKCkgLSAxKS5nZXQoIngiKS5hc0RvdWJsZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBkb3VibGUgZW5kTGFzdExpbmVZID0gZG9ja2Vyc05vZGUuZ2V0KGRvY2tlcnNOb2RlLnNpemUoKSAtIDEpLmdldCgieSIpLmFzRG91YmxlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVuZExhc3RMaW5lWCArPSB0YXJnZXRJbmZvLmdldFgoKTsKICAgICAgICAgICAgICAgICAgICAgICAgZW5kTGFzdExpbmVZICs9IHRhcmdldEluZm8uZ2V0WSgpOwogICAgICAgICAgICAgICAgICAgICAgICBsYXN0TGluZSA9IG5ldyBEb3VibGUoc3RhcnRMYXN0TGluZVgsIHN0YXJ0TGFzdExpbmVZLCBlbmRMYXN0TGluZVgsIGVuZExhc3RMaW5lWSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdExpbmUgPSBmaXJzdExpbmU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBBcmVhIHRhcmdldDJEID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBpZiAoRElfUkVDVEFOR0xFUy5jb250YWlucyh0YXJnZXRSZWZTdGVuY2lsSWQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldDJEID0gdGhpcy5jcmVhdGVSZWN0YW5nbGUodGFyZ2V0SW5mbyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChESV9DSVJDTEVTLmNvbnRhaW5zKHRhcmdldFJlZlN0ZW5jaWxJZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0RG9ja2Vyc1ggPSBkb2NrZXJzTm9kZS5nZXQoZG9ja2Vyc05vZGUuc2l6ZSgpIC0gMSkuZ2V0KCJ4IikuYXNEb3VibGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0RG9ja2Vyc1kgPSBkb2NrZXJzTm9kZS5nZXQoZG9ja2Vyc05vZGUuc2l6ZSgpIC0gMSkuZ2V0KCJ5IikuYXNEb3VibGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0MkQgPSB0aGlzLmNyZWF0ZUVsbGlwc2UodGFyZ2V0SW5mbywgdGFyZ2V0RG9ja2Vyc1gsIHRhcmdldERvY2tlcnNZKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKERJX0dBVEVXQVkuY29udGFpbnModGFyZ2V0UmVmU3RlbmNpbElkKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQyRCA9IHRoaXMuY3JlYXRlR2F0ZXdheSh0YXJnZXRJbmZvKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQyRCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIENvbGxlY3Rpb248UG9pbnQyRD4gaW50ZXJzZWN0aW9ucyA9IHRoaXMuZ2V0SW50ZXJzZWN0aW9ucyhsYXN0TGluZSwgdGFyZ2V0MkQpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW50ZXJzZWN0aW9ucyAhPSBudWxsICYmIGludGVyc2VjdGlvbnMuc2l6ZSgpID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgUG9pbnQyRCBpbnRlcnNlY3Rpb24gPSAoUG9pbnQyRClpbnRlcnNlY3Rpb25zLml0ZXJhdG9yKCkubmV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhcGhpY0luZm9MaXN0LmFkZCh0aGlzLmNyZWF0ZUdyYXBoaWNJbmZvKGludGVyc2VjdGlvbi5nZXRYKCksIGludGVyc2VjdGlvbi5nZXRZKCkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYXBoaWNJbmZvTGlzdC5hZGQodGhpcy5jcmVhdGVHcmFwaGljSW5mbyhsYXN0TGluZS5nZXRYMigpLCBsYXN0TGluZS5nZXRZMigpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGJwbW5Nb2RlbC5hZGRGbG93R3JhcGhpY0luZm9MaXN0KGVkZ2VJZCwgZ3JhcGhpY0luZm9MaXN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0KCiAgICBwcm90ZWN0ZWQgQXJlYSBjcmVhdGVFbGxpcHNlKEdyYXBoaWNJbmZvIHNvdXJjZUluZm8sIGRvdWJsZSBoYWxmV2lkdGgsIGRvdWJsZSBoYWxmSGVpZ2h0KSB7CiAgICAgICAgQXJlYSBvdXRlckNpcmNsZSA9IG5ldyBBcmVhKG5ldyBqYXZhLmF3dC5nZW9tLkVsbGlwc2UyRC5Eb3VibGUoc291cmNlSW5mby5nZXRYKCksIHNvdXJjZUluZm8uZ2V0WSgpLCAyLjBEICogaGFsZldpZHRoLCAyLjBEICogaGFsZkhlaWdodCkpOwogICAgICAgIEFyZWEgaW5uZXJDaXJjbGUgPSBuZXcgQXJlYShuZXcgamF2YS5hd3QuZ2VvbS5FbGxpcHNlMkQuRG91YmxlKHNvdXJjZUluZm8uZ2V0WCgpICsgdGhpcy5saW5lV2lkdGgsIHNvdXJjZUluZm8uZ2V0WSgpICsgdGhpcy5saW5lV2lkdGgsIDIuMEQgKiAoaGFsZldpZHRoIC0gdGhpcy5saW5lV2lkdGgpLCAyLjBEICogKGhhbGZIZWlnaHQgLSB0aGlzLmxpbmVXaWR0aCkpKTsKICAgICAgICBvdXRlckNpcmNsZS5zdWJ0cmFjdChpbm5lckNpcmNsZSk7CiAgICAgICAgcmV0dXJuIG91dGVyQ2lyY2xlOwogICAgfQoKICAgIHByb3RlY3RlZCBDb2xsZWN0aW9uPFBvaW50MkQ+IGdldEludGVyc2VjdGlvbnMoTGluZTJEIGxpbmUsIEFyZWEgc2hhcGUpIHsKICAgICAgICBBcmVhIGludGVyc2VjdGlvbkFyZWEgPSBuZXcgQXJlYSh0aGlzLmdldExpbmVTaGFwZShsaW5lKSk7CiAgICAgICAgaW50ZXJzZWN0aW9uQXJlYS5pbnRlcnNlY3Qoc2hhcGUpOwogICAgICAgIGlmICghaW50ZXJzZWN0aW9uQXJlYS5pc0VtcHR5KCkpIHsKICAgICAgICAgICAgUmVjdGFuZ2xlMkQgYm91bmRzMkQgPSBpbnRlcnNlY3Rpb25BcmVhLmdldEJvdW5kczJEKCk7CiAgICAgICAgICAgIEhhc2hTZXQ8UG9pbnQyRD4gaW50ZXJzZWN0aW9ucyA9IG5ldyBIYXNoU2V0KDEpOwogICAgICAgICAgICBpbnRlcnNlY3Rpb25zLmFkZChuZXcgamF2YS5hd3QuZ2VvbS5Qb2ludDJELkRvdWJsZShib3VuZHMyRC5nZXRYKCksIGJvdW5kczJELmdldFkoKSkpOwogICAgICAgICAgICByZXR1cm4gaW50ZXJzZWN0aW9uczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gQ29sbGVjdGlvbnMuRU1QVFlfU0VUOwogICAgICAgIH0KICAgIH0KCiAgICBwcm90ZWN0ZWQgU2hhcGUgZ2V0TGluZVNoYXBlKExpbmUyRCBsaW5lMkQpIHsKICAgICAgICBQYXRoMkQgbGluZSA9IG5ldyBqYXZhLmF3dC5nZW9tLlBhdGgyRC5Eb3VibGUoMSwgNCk7CiAgICAgICAgbGluZS5tb3ZlVG8obGluZTJELmdldFgxKCksIGxpbmUyRC5nZXRZMSgpKTsKICAgICAgICBsaW5lLmxpbmVUbyhsaW5lMkQuZ2V0WDIoKSwgbGluZTJELmdldFkyKCkpOwogICAgICAgIGxpbmUubGluZVRvKGxpbmUyRC5nZXRYMigpICsgdGhpcy5saW5lV2lkdGgsIGxpbmUyRC5nZXRZMigpICsgdGhpcy5saW5lV2lkdGgpOwogICAgICAgIGxpbmUuY2xvc2VQYXRoKCk7CiAgICAgICAgcmV0dXJuIGxpbmU7CiAgICB9CgogICAgcHJvdGVjdGVkIEFyZWEgY3JlYXRlUmVjdGFuZ2xlKEdyYXBoaWNJbmZvIGdyYXBoaWNJbmZvKSB7CiAgICAgICAgQXJlYSBvdXRlclJlY3RhbmdsZSA9IG5ldyBBcmVhKG5ldyBqYXZhLmF3dC5nZW9tLlJlY3RhbmdsZTJELkRvdWJsZShncmFwaGljSW5mby5nZXRYKCksIGdyYXBoaWNJbmZvLmdldFkoKSwgZ3JhcGhpY0luZm8uZ2V0V2lkdGgoKSwgZ3JhcGhpY0luZm8uZ2V0SGVpZ2h0KCkpKTsKICAgICAgICBBcmVhIGlubmVyUmVjdGFuZ2xlID0gbmV3IEFyZWEobmV3IGphdmEuYXd0Lmdlb20uUmVjdGFuZ2xlMkQuRG91YmxlKGdyYXBoaWNJbmZvLmdldFgoKSArIHRoaXMubGluZVdpZHRoLCBncmFwaGljSW5mby5nZXRZKCkgKyB0aGlzLmxpbmVXaWR0aCwgZ3JhcGhpY0luZm8uZ2V0V2lkdGgoKSAtIDIuMEQgKiB0aGlzLmxpbmVXaWR0aCwgZ3JhcGhpY0luZm8uZ2V0SGVpZ2h0KCkgLSAyLjBEICogdGhpcy5saW5lV2lkdGgpKTsKICAgICAgICBvdXRlclJlY3RhbmdsZS5zdWJ0cmFjdChpbm5lclJlY3RhbmdsZSk7CiAgICAgICAgcmV0dXJuIG91dGVyUmVjdGFuZ2xlOwogICAgfQoKICAgIHByb3RlY3RlZCBBcmVhIGNyZWF0ZUdhdGV3YXkoR3JhcGhpY0luZm8gZ3JhcGhpY0luZm8pIHsKICAgICAgICBBcmVhIG91dGVyR2F0ZXdheUFyZWEgPSBuZXcgQXJlYSh0aGlzLmNyZWF0ZUdhdGV3YXlTaGFwZShncmFwaGljSW5mby5nZXRYKCksIGdyYXBoaWNJbmZvLmdldFkoKSwgZ3JhcGhpY0luZm8uZ2V0V2lkdGgoKSwgZ3JhcGhpY0luZm8uZ2V0SGVpZ2h0KCkpKTsKICAgICAgICBBcmVhIGlubmVyR2F0ZXdheUFyZWEgPSBuZXcgQXJlYSh0aGlzLmNyZWF0ZUdhdGV3YXlTaGFwZShncmFwaGljSW5mby5nZXRYKCkgKyB0aGlzLmxpbmVXaWR0aCwgZ3JhcGhpY0luZm8uZ2V0WSgpICsgdGhpcy5saW5lV2lkdGgsIGdyYXBoaWNJbmZvLmdldFdpZHRoKCkgLSAyLjBEICogdGhpcy5saW5lV2lkdGgsIGdyYXBoaWNJbmZvLmdldEhlaWdodCgpIC0gMi4wRCAqIHRoaXMubGluZVdpZHRoKSk7CiAgICAgICAgb3V0ZXJHYXRld2F5QXJlYS5zdWJ0cmFjdChpbm5lckdhdGV3YXlBcmVhKTsKICAgICAgICByZXR1cm4gb3V0ZXJHYXRld2F5QXJlYTsKICAgIH0KCiAgICBwcml2YXRlIGphdmEuYXd0Lmdlb20uUGF0aDJELkRvdWJsZSBjcmVhdGVHYXRld2F5U2hhcGUoZG91YmxlIHgsIGRvdWJsZSB5LCBkb3VibGUgd2lkdGgsIGRvdWJsZSBoZWlnaHQpIHsKICAgICAgICBkb3VibGUgbWlkZGxlWCA9IHggKyB3aWR0aCAvIDIuMEQ7CiAgICAgICAgZG91YmxlIG1pZGRsZVkgPSB5ICsgaGVpZ2h0IC8gMi4wRDsKICAgICAgICBqYXZhLmF3dC5nZW9tLlBhdGgyRC5Eb3VibGUgZ2F0ZXdheVNoYXBlID0gbmV3IGphdmEuYXd0Lmdlb20uUGF0aDJELkRvdWJsZSgxLCA0KTsKICAgICAgICBnYXRld2F5U2hhcGUubW92ZVRvKHgsIG1pZGRsZVkpOwogICAgICAgIGdhdGV3YXlTaGFwZS5saW5lVG8obWlkZGxlWCwgeSk7CiAgICAgICAgZ2F0ZXdheVNoYXBlLmxpbmVUbyh4ICsgd2lkdGgsIG1pZGRsZVkpOwogICAgICAgIGdhdGV3YXlTaGFwZS5saW5lVG8obWlkZGxlWCwgeSArIGhlaWdodCk7CiAgICAgICAgZ2F0ZXdheVNoYXBlLmNsb3NlUGF0aCgpOwogICAgICAgIHJldHVybiBnYXRld2F5U2hhcGU7CiAgICB9CgogICAgcHJpdmF0ZSBHcmFwaGljSW5mbyBjcmVhdGVHcmFwaGljSW5mbyhkb3VibGUgeCwgZG91YmxlIHkpIHsKICAgICAgICBHcmFwaGljSW5mbyBncmFwaGljSW5mbyA9IG5ldyBHcmFwaGljSW5mbygpOwogICAgICAgIGdyYXBoaWNJbmZvLnNldFgoeCk7CiAgICAgICAgZ3JhcGhpY0luZm8uc2V0WSh5KTsKICAgICAgICByZXR1cm4gZ3JhcGhpY0luZm87CiAgICB9CgogICAgc3RhdGljIHsKICAgICAgICBTdGFydEV2ZW50SnNvbkNvbnZlcnRlci5maWxsVHlwZXMoY29udmVydGVyc1RvQnBtbk1hcCwgY29udmVydGVyc1RvSnNvbk1hcCk7CiAgICAgICAgRW5kRXZlbnRKc29uQ29udmVydGVyLmZpbGxUeXBlcyhjb252ZXJ0ZXJzVG9CcG1uTWFwLCBjb252ZXJ0ZXJzVG9Kc29uTWFwKTsKICAgICAgICBTZXF1ZW5jZUZsb3dKc29uQ29udmVydGVyLmZpbGxUeXBlcyhjb252ZXJ0ZXJzVG9CcG1uTWFwLCBjb252ZXJ0ZXJzVG9Kc29uTWFwKTsKICAgICAgICBNZXNzYWdlRmxvd0pzb25Db252ZXJ0ZXIuZmlsbFR5cGVzKGNvbnZlcnRlcnNUb0JwbW5NYXAsIGNvbnZlcnRlcnNUb0pzb25NYXApOwogICAgICAgIEFzc29jaWF0aW9uSnNvbkNvbnZlcnRlci5maWxsVHlwZXMoY29udmVydGVyc1RvQnBtbk1hcCwgY29udmVydGVyc1RvSnNvbk1hcCk7CiAgICAgICAgQnVzaW5lc3NSdWxlVGFza0pzb25Db252ZXJ0ZXIuZmlsbFR5cGVzKGNvbnZlcnRlcnNUb0JwbW5NYXAsIGNvbnZlcnRlcnNUb0pzb25NYXApOwogICAgICAgIE1haWxUYXNrSnNvbkNvbnZlcnRlci5maWxsVHlwZXMoY29udmVydGVyc1RvQnBtbk1hcCwgY29udmVydGVyc1RvSnNvbk1hcCk7CiAgICAgICAgTWFudWFsVGFza0pzb25Db252ZXJ0ZXIuZmlsbFR5cGVzKGNvbnZlcnRlcnNUb0JwbW5NYXAsIGNvbnZlcnRlcnNUb0pzb25NYXApOwogICAgICAgIFJlY2VpdmVUYXNrSnNvbkNvbnZlcnRlci5maWxsVHlwZXMoY29udmVydGVyc1RvQnBtbk1hcCwgY29udmVydGVyc1RvSnNvbk1hcCk7CiAgICAgICAgU2NyaXB0VGFza0pzb25Db252ZXJ0ZXIuZmlsbFR5cGVzKGNvbnZlcnRlcnNUb0JwbW5NYXAsIGNvbnZlcnRlcnNUb0pzb25NYXApOwogICAgICAgIFNlcnZpY2VUYXNrSnNvbkNvbnZlcnRlci5maWxsVHlwZXMoY29udmVydGVyc1RvQnBtbk1hcCwgY29udmVydGVyc1RvSnNvbk1hcCk7CiAgICAgICAgU2hlbGxUYXNrSnNvbkNvbnZlcnRlci5maWxsVHlwZXMoY29udmVydGVyc1RvQnBtbk1hcCwgY29udmVydGVyc1RvSnNvbk1hcCk7CiAgICAgICAgVXNlclRhc2tKc29uQ29udmVydGVyLmZpbGxUeXBlcyhjb252ZXJ0ZXJzVG9CcG1uTWFwLCBjb252ZXJ0ZXJzVG9Kc29uTWFwKTsKICAgICAgICBDYWxsQWN0aXZpdHlKc29uQ29udmVydGVyLmZpbGxUeXBlcyhjb252ZXJ0ZXJzVG9CcG1uTWFwLCBjb252ZXJ0ZXJzVG9Kc29uTWFwKTsKICAgICAgICBDYW1lbFRhc2tKc29uQ29udmVydGVyLmZpbGxUeXBlcyhjb252ZXJ0ZXJzVG9CcG1uTWFwLCBjb252ZXJ0ZXJzVG9Kc29uTWFwKTsKICAgICAgICBNdWxlVGFza0pzb25Db252ZXJ0ZXIuZmlsbFR5cGVzKGNvbnZlcnRlcnNUb0JwbW5NYXAsIGNvbnZlcnRlcnNUb0pzb25NYXApOwogICAgICAgIEh0dHBUYXNrSnNvbkNvbnZlcnRlci5maWxsVHlwZXMoY29udmVydGVyc1RvQnBtbk1hcCwgY29udmVydGVyc1RvSnNvbk1hcCk7CiAgICAgICAgU2VuZFRhc2tKc29uQ29udmVydGVyLmZpbGxUeXBlcyhjb252ZXJ0ZXJzVG9CcG1uTWFwLCBjb252ZXJ0ZXJzVG9Kc29uTWFwKTsKICAgICAgICBEZWNpc2lvblRhc2tKc29uQ29udmVydGVyLmZpbGxUeXBlcyhjb252ZXJ0ZXJzVG9CcG1uTWFwLCBjb252ZXJ0ZXJzVG9Kc29uTWFwKTsKICAgICAgICBFeGNsdXNpdmVHYXRld2F5SnNvbkNvbnZlcnRlci5maWxsVHlwZXMoY29udmVydGVyc1RvQnBtbk1hcCwgY29udmVydGVyc1RvSnNvbk1hcCk7CiAgICAgICAgSW5jbHVzaXZlR2F0ZXdheUpzb25Db252ZXJ0ZXIuZmlsbFR5cGVzKGNvbnZlcnRlcnNUb0JwbW5NYXAsIGNvbnZlcnRlcnNUb0pzb25NYXApOwogICAgICAgIFBhcmFsbGVsR2F0ZXdheUpzb25Db252ZXJ0ZXIuZmlsbFR5cGVzKGNvbnZlcnRlcnNUb0JwbW5NYXAsIGNvbnZlcnRlcnNUb0pzb25NYXApOwogICAgICAgIEV2ZW50R2F0ZXdheUpzb25Db252ZXJ0ZXIuZmlsbFR5cGVzKGNvbnZlcnRlcnNUb0JwbW5NYXAsIGNvbnZlcnRlcnNUb0pzb25NYXApOwogICAgICAgIFN1YlByb2Nlc3NKc29uQ29udmVydGVyLmZpbGxUeXBlcyhjb252ZXJ0ZXJzVG9CcG1uTWFwLCBjb252ZXJ0ZXJzVG9Kc29uTWFwKTsKICAgICAgICBFdmVudFN1YlByb2Nlc3NKc29uQ29udmVydGVyLmZpbGxUeXBlcyhjb252ZXJ0ZXJzVG9CcG1uTWFwLCBjb252ZXJ0ZXJzVG9Kc29uTWFwKTsKICAgICAgICBBZGhvY1N1YlByb2Nlc3NKc29uQ29udmVydGVyLmZpbGxUeXBlcyhjb252ZXJ0ZXJzVG9CcG1uTWFwLCBjb252ZXJ0ZXJzVG9Kc29uTWFwKTsKICAgICAgICBDYXRjaEV2ZW50SnNvbkNvbnZlcnRlci5maWxsVHlwZXMoY29udmVydGVyc1RvQnBtbk1hcCwgY29udmVydGVyc1RvSnNvbk1hcCk7CiAgICAgICAgVGhyb3dFdmVudEpzb25Db252ZXJ0ZXIuZmlsbFR5cGVzKGNvbnZlcnRlcnNUb0JwbW5NYXAsIGNvbnZlcnRlcnNUb0pzb25NYXApOwogICAgICAgIEJvdW5kYXJ5RXZlbnRKc29uQ29udmVydGVyLmZpbGxUeXBlcyhjb252ZXJ0ZXJzVG9CcG1uTWFwLCBjb252ZXJ0ZXJzVG9Kc29uTWFwKTsKICAgICAgICBUZXh0QW5ub3RhdGlvbkpzb25Db252ZXJ0ZXIuZmlsbFR5cGVzKGNvbnZlcnRlcnNUb0JwbW5NYXAsIGNvbnZlcnRlcnNUb0pzb25NYXApOwogICAgICAgIERhdGFTdG9yZUpzb25Db252ZXJ0ZXIuZmlsbFR5cGVzKGNvbnZlcnRlcnNUb0JwbW5NYXAsIGNvbnZlcnRlcnNUb0pzb25NYXApOwogICAgICAgIERJX0NJUkNMRVMgPSBuZXcgQXJyYXlMaXN0KCk7CiAgICAgICAgRElfUkVDVEFOR0xFUyA9IG5ldyBBcnJheUxpc3QoKTsKICAgICAgICBESV9HQVRFV0FZID0gbmV3IEFycmF5TGlzdCgpOwogICAgICAgIERJX0NJUkNMRVMuYWRkKCJTdGFydEVycm9yRXZlbnQiKTsKICAgICAgICBESV9DSVJDTEVTLmFkZCgiU3RhcnRNZXNzYWdlRXZlbnQiKTsKICAgICAgICBESV9DSVJDTEVTLmFkZCgiU3RhcnROb25lRXZlbnQiKTsKICAgICAgICBESV9DSVJDTEVTLmFkZCgiU3RhcnRUaW1lckV2ZW50Iik7CiAgICAgICAgRElfQ0lSQ0xFUy5hZGQoIlN0YXJ0U2lnbmFsRXZlbnQiKTsKICAgICAgICBESV9DSVJDTEVTLmFkZCgiQm91bmRhcnlFcnJvckV2ZW50Iik7CiAgICAgICAgRElfQ0lSQ0xFUy5hZGQoIkJvdW5kYXJ5U2lnbmFsRXZlbnQiKTsKICAgICAgICBESV9DSVJDTEVTLmFkZCgiQm91bmRhcnlUaW1lckV2ZW50Iik7CiAgICAgICAgRElfQ0lSQ0xFUy5hZGQoIkJvdW5kYXJ5TWVzc2FnZUV2ZW50Iik7CiAgICAgICAgRElfQ0lSQ0xFUy5hZGQoIkJvdW5kYXJ5Q2FuY2VsRXZlbnQiKTsKICAgICAgICBESV9DSVJDTEVTLmFkZCgiQm91bmRhcnlDb21wZW5zYXRpb25FdmVudCIpOwogICAgICAgIERJX0NJUkNMRVMuYWRkKCJDYXRjaE1lc3NhZ2VFdmVudCIpOwogICAgICAgIERJX0NJUkNMRVMuYWRkKCJDYXRjaFNpZ25hbEV2ZW50Iik7CiAgICAgICAgRElfQ0lSQ0xFUy5hZGQoIkNhdGNoVGltZXJFdmVudCIpOwogICAgICAgIERJX0NJUkNMRVMuYWRkKCJUaHJvd05vbmVFdmVudCIpOwogICAgICAgIERJX0NJUkNMRVMuYWRkKCJUaHJvd1NpZ25hbEV2ZW50Iik7CiAgICAgICAgRElfQ0lSQ0xFUy5hZGQoIkVuZE5vbmVFdmVudCIpOwogICAgICAgIERJX0NJUkNMRVMuYWRkKCJFbmRFcnJvckV2ZW50Iik7CiAgICAgICAgRElfQ0lSQ0xFUy5hZGQoIkVuZENhbmNlbEV2ZW50Iik7CiAgICAgICAgRElfQ0lSQ0xFUy5hZGQoIkVuZFRlcm1pbmF0ZUV2ZW50Iik7CiAgICAgICAgRElfUkVDVEFOR0xFUy5hZGQoIkNhbGxBY3Rpdml0eSIpOwogICAgICAgIERJX1JFQ1RBTkdMRVMuYWRkKCJTdWJQcm9jZXNzIik7CiAgICAgICAgRElfUkVDVEFOR0xFUy5hZGQoIkNvbGxhcHNlZFN1YlByb2Nlc3MiKTsKICAgICAgICBESV9SRUNUQU5HTEVTLmFkZCgiRXZlbnRTdWJQcm9jZXNzIik7CiAgICAgICAgRElfUkVDVEFOR0xFUy5hZGQoIkFkaG9jU3ViUHJvY2VzcyIpOwogICAgICAgIERJX1JFQ1RBTkdMRVMuYWRkKCJCdXNpbmVzc1J1bGUiKTsKICAgICAgICBESV9SRUNUQU5HTEVTLmFkZCgiTWFpbFRhc2siKTsKICAgICAgICBESV9SRUNUQU5HTEVTLmFkZCgiTWFudWFsVGFzayIpOwogICAgICAgIERJX1JFQ1RBTkdMRVMuYWRkKCJSZWNlaXZlVGFzayIpOwogICAgICAgIERJX1JFQ1RBTkdMRVMuYWRkKCJTY3JpcHRUYXNrIik7CiAgICAgICAgRElfUkVDVEFOR0xFUy5hZGQoIlNlbmRUYXNrIik7CiAgICAgICAgRElfUkVDVEFOR0xFUy5hZGQoIlNlcnZpY2VUYXNrIik7CiAgICAgICAgRElfUkVDVEFOR0xFUy5hZGQoIlVzZXJUYXNrIik7CiAgICAgICAgRElfUkVDVEFOR0xFUy5hZGQoIkNhbWVsVGFzayIpOwogICAgICAgIERJX1JFQ1RBTkdMRVMuYWRkKCJNdWxlVGFzayIpOwogICAgICAgIERJX1JFQ1RBTkdMRVMuYWRkKCJIdHRwVGFzayIpOwogICAgICAgIERJX1JFQ1RBTkdMRVMuYWRkKCJEZWNpc2lvblRhc2siKTsKICAgICAgICBESV9SRUNUQU5HTEVTLmFkZCgiU2hlbGxUYXNrIik7CiAgICAgICAgRElfUkVDVEFOR0xFUy5hZGQoIlRleHRBbm5vdGF0aW9uIik7CiAgICAgICAgRElfR0FURVdBWS5hZGQoIkV2ZW50R2F0ZXdheSIpOwogICAgICAgIERJX0dBVEVXQVkuYWRkKCJFeGNsdXNpdmVHYXRld2F5Iik7CiAgICAgICAgRElfR0FURVdBWS5hZGQoIkluY2x1c2l2ZUdhdGV3YXkiKTsKICAgICAgICBESV9HQVRFV0FZLmFkZCgiUGFyYWxsZWxHYXRld2F5Iik7CiAgICB9CgogICAgY2xhc3MgRmxvd1dpdGhDb250YWluZXIgewogICAgICAgIHByb3RlY3RlZCBTZXF1ZW5jZUZsb3cgc2VxdWVuY2VGbG93OwogICAgICAgIHByb3RlY3RlZCBGbG93RWxlbWVudHNDb250YWluZXIgZmxvd0NvbnRhaW5lcjsKCiAgICAgICAgcHVibGljIEZsb3dXaXRoQ29udGFpbmVyKFNlcXVlbmNlRmxvdyBzZXF1ZW5jZUZsb3csIEZsb3dFbGVtZW50c0NvbnRhaW5lciBmbG93Q29udGFpbmVyKSB7CiAgICAgICAgICAgIHRoaXMuc2VxdWVuY2VGbG93ID0gc2VxdWVuY2VGbG93OwogICAgICAgICAgICB0aGlzLmZsb3dDb250YWluZXIgPSBmbG93Q29udGFpbmVyOwogICAgICAgIH0KCiAgICAgICAgcHVibGljIFNlcXVlbmNlRmxvdyBnZXRTZXF1ZW5jZUZsb3coKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnNlcXVlbmNlRmxvdzsKICAgICAgICB9CgogICAgICAgIHB1YmxpYyB2b2lkIHNldFNlcXVlbmNlRmxvdyhTZXF1ZW5jZUZsb3cgc2VxdWVuY2VGbG93KSB7CiAgICAgICAgICAgIHRoaXMuc2VxdWVuY2VGbG93ID0gc2VxdWVuY2VGbG93OwogICAgICAgIH0KCiAgICAgICAgcHVibGljIEZsb3dFbGVtZW50c0NvbnRhaW5lciBnZXRGbG93Q29udGFpbmVyKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5mbG93Q29udGFpbmVyOwogICAgICAgIH0KCiAgICAgICAgcHVibGljIHZvaWQgc2V0Rmxvd0NvbnRhaW5lcihGbG93RWxlbWVudHNDb250YWluZXIgZmxvd0NvbnRhaW5lcikgewogICAgICAgICAgICB0aGlzLmZsb3dDb250YWluZXIgPSBmbG93Q29udGFpbmVyOwogICAgICAgIH0KICAgIH0=</text>
      </register>
      <register name="1" type="4">
        <text encoding="base64">IHsKICAgICAgICAgIHZhbHVlLm1hcChpID0+CgogICAgICAgICAgICAgIDxUYWcgc3R5bGU9e3toZWlnaHQ6JzI3cHgnfX0gY29sb3I9JyNmMWU2ZTY3ZCc+CiAgICAgICAgICAgICAgPFRhZyBrZXk9e2kua2V5ICsgJy10YWcnfSBzdHlsZT17e2hlaWdodDonMjNweCd9fSAgY29sb3I9IiMxMDhlZTkiPntpLm5hbWV9PC9UYWc+CiAgICAgICAgICAgICAgPFNlbGVjdAogICAgICAgICAgICAgICAga2V5PXtpLmtleSArICctc2VsZWN0J30KICAgICAgICAgICAgICAgIGRlZmF1bHRWYWx1ZT17aS5wZXJtaXNzaW9ufQogICAgICAgICAgICAgICAgc2l6ZT17J3NtYWxsJ30KICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLmhhbmRsZUNoYW5nZX0KICAgICAgICAgICAgICAgIHN0eWxlPXt7d2lkdGg6ICc2NXB4JyxtYXJnaW5MZWZ0OictOHB4J319CiAgICAgICAgICAgICAgPgogICAgICAgICAgICAgICAgPE9wdGlvbiBrZXk9e2kua2V5ICsgJy13cml0ZSd9IHZhbHVlPSJ3cml0ZSI+5Y+v5YaZPC9PcHRpb24+CiAgICAgICAgICAgICAgICA8T3B0aW9uIGtleT17aS5rZXkgKyAnLWRpc2FibGVkJ30gdmFsdWU9ImRpc2FibGVkIj7lj6ror7s8L09wdGlvbj4KICAgICAgICAgICAgICAgIDxPcHRpb24ga2V5PXtpLmtleSArICctaGlkZGVuJ30gdmFsdWU9ImhpZGRlbiI+6ZqQ6JePPC9PcHRpb24+CiAgICAgICAgICAgICAgPC9TZWxlY3Q+CiAgICAgICAgICAgICAgPC9UYWc+CgogICAgICAgICAgKQogICAgICAgIH0=</text>
      </register>
      <register name="q" type="4">
        <text />
      </register>
      <register name="2" type="4">
        <text encoding="base64">IDxTZWxlY3QKICAgICAgICAgICAgICBtb2RlPSJtdWx0aXBsZSIKICAgICAgICAgICAgICBzdHlsZT17e3dpZHRoOiAnMTAwJSd9fQogICAgICAgICAgICAgIHBsYWNlaG9sZGVyPSLpgInmi6nlvoXpgInpg6jpl6giCiAgICAgICAgICAgICAgb3B0aW9uTGFiZWxQcm9wPSJsYWJlbCIKICAgICAgICAgICAgICBmaWx0ZXJPcHRpb249eyhpbnB1dCwgb3B0aW9uKSA9PgogICAgICAgICAgICAgICAgb3B0aW9uLnByb3BzLmNoaWxkcmVuLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihpbnB1dC50b0xvd2VyQ2FzZSgpKSA+PSAwCiAgICAgICAgICAgICAgfQogICAgICAgICAgICA+</text>
      </register>
      <register name="3" type="4">
        <text encoding="base64">ICAgICAgICA8Rm9ybUl0ZW0ga2V5PXtcJ3JvbGVzXCd9IGxhYmVsQ29sPXt7c3BhbjogM319IHdyYXBwZXJDb2w9e3tzcGFuOiAyMH19IGxhYmVsPSLlvoXpgInop5LoibIiPlxuJyArCiAgICAgICAgJyAgICAgICAgICB7Zm9ybS5nZXRGaWVsZERlY29yYXRvcihcJ3JvbGVzXCcsIHtcbicgKwogICAgICAgICcgICAgICAgICAgICBpbml0aWFsVmFsdWU6IGkucHJvcGVydGllcy5wcm9jZXNzX2dsb2JlbHNldHRpbmdzID8gaS5wcm9wZXJ0aWVzLnByb2Nlc3NfZ2xvYmVsc2V0dGluZ3Mucm9sZXMgOiBbXSxcbicgKwogICAgICAgICcgICAgICAgICAgICBydWxlczogW3tyZXF1aXJlZDogdGhpcy5zdGFydEZvcm1QZXJtaXNzaW9uc1JlcXVpcmUoKSwgbWVzc2FnZTogXCfor7fpgInmi6nlvoXpgInop5LoibJcJ31dLFxuJyArCiAgICAgICAgJyAgICAgICAgICB9KShcbicgKwogICAgICAgICcgICAgICAgICAgICA8U2VsZWN0XG4nICsKICAgICAgICAnICAgICAgICAgICAgICBtb2RlPSJtdWx0aXBsZSJcbicgKwogICAgICAgICcgICAgICAgICAgICAgIHN0eWxlPXt7d2lkdGg6IFwnMTAwJVwnfX1cbicgKwogICAgICAgICcgICAgICAgICAgICAgIHBsYWNlaG9sZGVyPSLpgInmi6nlvoXpgInop5LoibIiXG4nICsKICAgICAgICAnICAgICAgICAgICAgICBvcHRpb25MYWJlbFByb3A9ImxhYmVsIlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAgZmlsdGVyT3B0aW9uPXsoaW5wdXQsIG9wdGlvbikgPT5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgb3B0aW9uLnByb3BzLmNoaWxkcmVuLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihpbnB1dC50b0xvd2VyQ2FzZSgpKSA+PSAwXG4nICsKICAgICAgICAnICAgICAgICAgICAgICB9XG4nICsKICAgICAgICAnICAgICAgICAgICAgPlxuJyArCiAgICAgICAgJyAgICAgICAgICAgICAge3JvbGVzLm1hcChpdGVtID0+IChcbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgPE9wdGlvbiBrZXk9e2l0ZW0uaWR9IGxhYmVsPXtpdGVtLnJvbGVOYW1lfT5cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgICB7aXRlbS5yb2xlTmFtZX1cbicgKwogICAgICAgICcgICAgICAgICAgICAgICAgPC9PcHRpb24+XG4nICsKICAgICAgICAnICAgICAgICAgICAgICApKX1cbicgKwogICAgICAgICcgICAgICAgICAgICA8L1NlbGVjdD5cbicgKwogICAgICAgICcgICAgICAgICAgKX1cbicgKwogICAgICAgICcgICAgICAgIDwvRm9ybUl0ZW0+LFxu</text>
      </register>
      <register name="4" type="2">
        <text encoding="base64">c3ByaW5nLnNlc3Npb24uc3RvcmUtdHlwZT1yZWRpcwo=</text>
      </register>
      <register name="5" type="4">
        <text encoding="base64">IGNvbnN0IHtpbmZvfSA9IHRoaXMuc3RhdGU7CiAgICBpZiAoaW5mbykgewogICAgICByZXR1cm4gaW5mbzsKICAgIH0=</text>
      </register>
      <register name="6" type="4">
        <text encoding="base64">IGNvbnN0IHtpbmZvfSA9IHRoaXMuc3RhdGU7CiAgICAvLyBpZiAoaW5mbykgewogICAgLy8gICByZXR1cm4gaW5mbzsKICAgIC8vIH0=</text>
      </register>
      <register name="7" type="4">
        <text encoding="base64">cHVibGljIHN0YXRpYyBKU09OT2JqZWN0IGdldFByb2Nlc3NHbG9iZWxTZXR0aW5nc0J5UHJvY2Vzc0luc3RhbmNlSWQoUmVwb3NpdG9yeVNlcnZpY2UgcmVwb3NpdG9yeVNlcnZpY2UsU3RyaW5nIGlkKXsKICAgICAgICAKICAgICAgICByZXBvc2l0b3J5U2VydmljZS5nZQogICAgICAgIAogICAgICAgIEpTT05PYmplY3QganNvbk9iamVjdD1uZXcgSlNPTk9iamVjdCgpOwogICAgICAgIEJwbW5Nb2RlbCBicG1uTW9kZWwgPSByZXBvc2l0b3J5U2VydmljZS5nZXRCcG1uTW9kZWwoaWQpOwogICAgICAgIFByb2Nlc3MgbWFpblByb2Nlc3MgPSBicG1uTW9kZWwuZ2V0TWFpblByb2Nlc3MoKTsKICAgICAgICBTdHJpbmcgcHJvY2Vzc0dsb2JlbFNldHRpbmdzID0gInByb2Nlc3NHbG9iZWxTZXR0aW5ncyI7CiAgICAgICAgTGlzdDxFeHRlbnNpb25FbGVtZW50PiBleHRlbnNpb25FbGVtZW50cyA9IG1haW5Qcm9jZXNzLmdldEV4dGVuc2lvbkVsZW1lbnRzKCkuZ2V0KHByb2Nlc3NHbG9iZWxTZXR0aW5ncyk7CiAgICAgICAgaWYoZXh0ZW5zaW9uRWxlbWVudHMhPW51bGwmJighZXh0ZW5zaW9uRWxlbWVudHMuaXNFbXB0eSgpKSl7CiAgICAgICAgICAgIEV4dGVuc2lvbkVsZW1lbnQgZXh0ZW5zaW9uRWxlbWVudCA9IGV4dGVuc2lvbkVsZW1lbnRzLmdldCgwKTsKICAgICAgICAgICAgU3RyaW5nIGVsZW1lbnRUZXh0ID0gZXh0ZW5zaW9uRWxlbWVudC5nZXRFbGVtZW50VGV4dCgpOwogICAgICAgICAgICBqc29uT2JqZWN0ID0gSlNPTi5wYXJzZU9iamVjdChlbGVtZW50VGV4dCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBqc29uT2JqZWN0OwogICAgfQ==</text>
      </register>
      <register name="8" type="4">
        <text encoding="base64">IHtsYWJlbDogJ+WQr+WKqOa1geeoiycsIHZhbHVlOiAnc3RhcnQnfSwKICAgIHtsYWJlbDogJ+i9rOS6pOaMh+WumuS6uuWRmCcsIHZhbHVlOiAnc2V0TmV4dFVzZXInfSwKICAgIHtsYWJlbDogJ+S4tOaXtuWKoOetvicsIHZhbHVlOiAnYWRkJ30sCiAgICB7bGFiZWw6ICflrozmiJAnLCB2YWx1ZTogJ25leHQnfSwKICAgIHtsYWJlbDogJ+mps+WbnicsIHZhbHVlOiAncmVqZWN0ZWQnfSwKICAgIHtsYWJlbDogJ+iHquWumuS5iemps+WbnicsIHZhbHVlOiAncmVqZWN0ZWRCeVNlbGVjdCd9LAogICAge2xhYmVsOiAn5YWz5rOo5rWB56iLJywgdmFsdWU6ICdmb2N1cyd9LAogICAge2xhYmVsOiAn5Y6G5Y+y6K6w5b2VJywgdmFsdWU6ICdoaXN0b3J5J30sCiAgICB7bGFiZWw6ICfmtYHnqIvlm74nLCB2YWx1ZTogJ2ltYWdlJ30=</text>
      </register>
      <register name="9" type="4">
        <text>for (String i : keySet) {
                    settings.getJSONObject()



            }</text>
      </register>
      <register name=":" type="4">
        <text>290</text>
      </register>
    </registers>
    <search>
      <last-search encoding="base64">XDwiXD4=</last-search>
      <last-offset />
      <last-pattern encoding="base64">XDwiXD4=</last-pattern>
      <last-dir>-1</last-dir>
      <show-last>false</show-last>
    </search>
    <history>
      <history-search>
        <entry>state</entry>
        <entry>render</entry>
        <entry encoding="base64">XDxjb21wbGV0ZVw+</entry>
        <entry encoding="base64">XDwiXD4=</entry>
      </history-search>
      <history-cmd>
        <entry>mark</entry>
        <entry>marks</entry>
        <entry>action SearchEverywhere</entry>
        <entry>w</entry>
        <entry>600</entry>
        <entry>wq</entry>
        <entry>54</entry>
        <entry>74</entry>
        <entry>582</entry>
        <entry>action Find</entry>
        <entry>290</entry>
      </history-cmd>
      <history-expr />
      <history-input />
    </history>
    <shortcut-conflicts>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed J</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed H</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed L</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed D</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed V</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed K</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed F</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed E</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed I</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed A</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed P</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed N</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed 2</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed G</text>
      </shortcut-conflict>
      <shortcut-conflict owner="ide">
        <text>ctrl pressed O</text>
      </shortcut-conflict>
    </shortcut-conflicts>
    <editor>
      <key-repeat enabled="true" />
    </editor>
  </component>
</application>